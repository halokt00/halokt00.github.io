<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thiên Đạo Tu Tiên - Webgame Text RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #0f172a; color: #e2e8f0;
            background-image: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
        }
        .game-title { font-family: 'Cinzel', serif; text-shadow: 0 0 10px rgba(234, 179, 8, 0.5); }
        .menu-btn { transition: all 0.2s ease; }
        .menu-btn:hover { transform: translateY(-2px); box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        
        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.9; filter: brightness(1); }
            50% { transform: scale(1.02); opacity: 1; filter: brightness(1.2); box-shadow: 0 0 30px rgba(234, 179, 8, 0.4); }
        }
        .meditating-img { animation: breathe 4s ease-in-out infinite; }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Element Colors */
        .elem-kim { color: #facc15; } /* Gold */
        .elem-moc { color: #4ade80; } /* Green */
        .elem-thuy { color: #60a5fa; } /* Blue */
        .elem-hoa { color: #f87171; } /* Red */
        .elem-tho { color: #a8a29e; } /* Brown/Gray */
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <input type="file" id="file-upload" class="hidden" accept=".json" onchange="handleFileUpload(this)">

    <div id="main-menu" class="w-full max-w-md text-center space-y-8">
        <div class="space-y-2">
            <i class="fa-solid fa-yin-yang text-6xl text-yellow-500 animate-spin" style="animation-duration: 10s;"></i>
            <h1 class="text-4xl md:text-5xl font-bold text-yellow-500 game-title tracking-wider mt-4">
                THIÊN ĐẠO <br> <span class="text-white text-2xl md:text-3xl">TU TIÊN</span>
            </h1>
        </div>
        <div class="flex flex-col gap-4 px-8">
            <button id="btn-continue" onclick="continueGame()" class="hidden menu-btn bg-green-900 border border-green-700 text-green-100 py-3 rounded-lg font-bold uppercase tracking-widest shadow-lg">
                <i class="fa-solid fa-play mr-2"></i> Tiếp Tục
            </button>
            <button onclick="newGame()" class="menu-btn bg-gray-800 border border-gray-600 hover:bg-gray-700 text-gray-200 py-3 rounded-lg font-bold uppercase tracking-widest shadow-lg">
                <i class="fa-solid fa-plus mr-2"></i> Chơi Mới
            </button>
            <button onclick="triggerFileInput()" class="menu-btn bg-blue-900 border border-blue-700 hover:bg-blue-800 text-blue-100 py-3 rounded-lg font-bold uppercase tracking-widest shadow-lg">
                <i class="fa-solid fa-upload mr-2"></i> Tải Save
            </button>
        </div>
        <div class="text-xs text-gray-600 mt-8">Ver 1.4.0 - Đạo Lộ & Linh Căn</div>
    </div>

    <div id="modal-selection" class="hidden fixed inset-0 bg-black z-[100] flex items-center justify-center p-4">
        <div class="bg-gray-900 w-full max-w-4xl h-[90vh] border border-yellow-600 rounded-lg flex flex-col shadow-2xl relative overflow-hidden">
            <div class="bg-gray-800 p-4 border-b border-gray-700 text-center">
                <h2 class="text-2xl font-bold text-yellow-500 uppercase tracking-widest">Khởi Đầu Tu Tiên Lộ</h2>
                <p class="text-gray-400 text-xs mt-1">Hãy chọn Đạo Lộ và Linh Căn để bắt đầu</p>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 grid grid-cols-1 md:grid-cols-2 gap-8 custom-scroll">
                
                <div class="space-y-4">
                    <h3 class="text-xl font-bold text-white border-b border-gray-600 pb-2"><i class="fa-solid fa-road mr-2"></i>Chọn Đạo Lộ</h3>
                    <div class="grid grid-cols-1 gap-2" id="dao-selection-list">
                        </div>
                </div>

                <div class="space-y-4">
                    <h3 class="text-xl font-bold text-white border-b border-gray-600 pb-2"><i class="fa-solid fa-fire mr-2"></i>Chọn Linh Căn</h3>
                    <div class="grid grid-cols-1 gap-2" id="root-selection-list">
                         </div>
                </div>
            </div>

            <div class="p-4 bg-gray-800 border-t border-gray-700 flex justify-between items-center">
                <div class="text-xs text-gray-400">
                    <div id="sel-preview-dao">Đạo: <span class="text-gray-600">Chưa chọn</span></div>
                    <div id="sel-preview-root">Căn: <span class="text-gray-600">Chưa chọn</span></div>
                </div>
                <button onclick="confirmSelection()" id="btn-confirm-sel" class="px-8 py-3 bg-gray-700 text-gray-400 font-bold rounded cursor-not-allowed" disabled>BƯỚC VÀO TU TIÊN</button>
            </div>
        </div>
    </div>

    <div id="game-container" class="hidden w-full max-w-4xl h-[90vh] bg-gray-900 border border-gray-700 rounded-xl shadow-2xl relative overflow-hidden flex flex-col">
        <div class="bg-gray-800 p-4 border-b border-gray-700 flex flex-wrap justify-between items-center shadow-md z-10 gap-2">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gray-700 border border-yellow-600 flex items-center justify-center text-yellow-500 relative group">
                    <i class="fa-solid fa-user-ninja"></i>
                    <div class="absolute top-full left-0 mt-2 w-48 bg-black border border-gray-600 p-2 rounded hidden group-hover:block z-50 text-xs">
                        <div id="tooltip-dao" class="font-bold text-white"></div>
                        <div id="tooltip-root" class="font-bold"></div>
                    </div>
                </div>
                <div>
                    <div id="display-name" class="font-bold text-yellow-500 leading-tight truncate max-w-[120px]">Vô Danh</div>
                    <div id="display-realm" class="text-xs text-cyan-300 font-bold truncate max-w-[120px]">Phàm Nhân</div>
                </div>
            </div>
             <div class="flex items-center gap-4 bg-gray-900 px-3 py-1 rounded border border-gray-700">
                <div class="flex items-center text-blue-400 text-sm font-bold" title="Linh Thạch">
                    <span class="mr-2 text-gray-400 text-xs uppercase">Linh Thạch:</span>
                    <span id="display-stones">0</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="exportSaveFile()" class="text-xs bg-green-800 hover:bg-green-700 text-white px-3 py-1 rounded border border-green-600"><i class="fa-solid fa-download"></i> Lưu</button>
                <button onclick="returnToMenu()" class="text-xs bg-red-900 hover:bg-red-800 text-white px-3 py-1 rounded border border-red-700"><i class="fa-solid fa-right-from-bracket"></i> Thoát</button>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] relative flex flex-col items-center justify-center">
            <div class="max-w-md w-full text-center space-y-6 relative z-10">
                <div class="relative w-64 h-64 mx-auto rounded-full border-4 border-yellow-600/50 overflow-hidden shadow-[0_0_30px_rgba(234,179,8,0.2)] bg-black">
                    <img src="https://i.pinimg.com/564x/c1/8d/19/c18d19606a928b9d4b0a7341b833c26d.jpg" alt="Tu Luyện" class="w-full h-full object-cover meditating-img">
                    <div class="absolute inset-0 bg-gradient-to-t from-gray-900/80 via-transparent to-transparent"></div>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-yellow-100">Đang Nhập Định Tu Hành...</h2>
                    <p class="text-sm text-cyan-400 animate-pulse mt-1"><i class="fa-solid fa-seedling mr-1"></i> Tự động hấp thu Thiên Địa Linh Khí</p>
                    <p id="gain-rate-text" class="text-xs text-gray-500 mt-2"></p>
                </div>
                <div class="bg-gray-800 rounded-full h-6 w-full border border-gray-600 relative overflow-hidden shadow">
                    <div id="exp-bar" class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 transition-all duration-500 ease-out" style="width: 0%"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)]">
                        <span id="exp-text">0 / 100</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 p-2 border-t border-gray-700 flex justify-center gap-4 z-20">
            <button onclick="openCharacterModal()" class="flex flex-col items-center justify-center w-20 h-16 bg-gray-700 hover:bg-gray-600 rounded border border-gray-600 text-yellow-500 transition relative">
                <i class="fa-solid fa-user-shield text-xl mb-1"></i>
                <span class="text-[10px] font-bold uppercase">Nhân Vật</span>
                <div id="noti-char" class="hidden absolute top-1 right-1 w-3 h-3 bg-red-500 rounded-full border border-gray-800"></div>
            </button>
        </div>
    </div>

    <div id="modal-character" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 w-full max-w-2xl h-[85vh] border border-gray-600 rounded-lg flex flex-col shadow-2xl relative">
            <div class="flex justify-between items-center p-3 border-b border-gray-700 bg-gray-800">
                <h3 class="text-yellow-500 font-bold text-lg"><i class="fa-solid fa-user-circle mr-2"></i>Thông Tin Nhân Vật</h3>
                <button onclick="closeCharacterModal()" class="text-gray-400 hover:text-white w-8 h-8"><i class="fa-solid fa-times text-xl"></i></button>
            </div>

            <div class="flex-1 flex flex-col overflow-hidden">
                <div class="flex border-b border-gray-700 bg-gray-800/50">
                    <button onclick="switchCharTab('info')" id="tab-btn-info" class="flex-1 py-3 text-sm font-bold text-yellow-500 border-b-2 border-yellow-500 bg-gray-800">CƠ BẢN</button>
                    <button onclick="switchCharTab('stats')" id="tab-btn-stats" class="flex-1 py-3 text-sm font-bold text-gray-400">THUỘC TÍNH</button>
                    <button onclick="switchCharTab('upgrade')" id="tab-btn-upgrade" class="flex-1 py-3 text-sm font-bold text-gray-400">TU HÀNH</button>
                </div>

                <div id="tab-content-info" class="flex-1 overflow-y-auto p-4 custom-scroll space-y-6">
                    <div>
                        <div class="text-xs text-gray-500 mb-2 uppercase tracking-wider font-bold">Trang Bị</div>
                        <div class="grid grid-cols-4 gap-2 md:gap-4" id="equip-slots-container"></div>
                    </div>
                    <hr class="border-gray-700">
                    <div>
                        <div class="flex justify-between items-end mb-2">
                            <div class="text-xs text-gray-500 uppercase tracking-wider font-bold">Tiềm Năng</div>
                            <div class="text-sm text-yellow-400">Điểm dư: <span id="val-potential" class="font-bold text-lg">0</span></div>
                        </div>
                        <div class="space-y-2" id="attributes-list"></div>
                    </div>
                </div>

                <div id="tab-content-stats" class="hidden flex-1 overflow-y-auto p-4 custom-scroll">
                    <div class="grid grid-cols-1 gap-2 text-sm" id="detailed-stats-container"></div>
                </div>

                <div id="tab-content-upgrade" class="hidden flex-1 overflow-y-auto p-4 custom-scroll space-y-6">
                    <div class="bg-gray-800/50 p-3 rounded border border-gray-700">
                        <h4 class="text-yellow-500 font-bold mb-2 flex justify-between">
                            <span><i class="fa-solid fa-road mr-1"></i> Đạo Lộ: <span id="upg-dao-name">---</span></span>
                            <span class="text-xs text-gray-400">Khắc chế: <span id="upg-dao-counter" class="text-white">---</span></span>
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-gray-900 p-2 rounded text-center">
                                <div class="text-xs text-gray-400">Căn Cơ (Lv.<span id="dao-base-lv">0</span>)</div>
                                <div class="text-[10px] text-gray-500 mb-1">+Chỉ số cơ bản</div>
                                <button onclick="upgradeDao('base')" class="w-full bg-blue-900 hover:bg-blue-800 text-xs py-1 rounded border border-blue-700">
                                    Up (1000 Đá)
                                </button>
                            </div>
                            <div class="bg-gray-900 p-2 rounded text-center">
                                <div class="text-xs text-gray-400">Thiên Phú (Lv.<span id="dao-talent-lv">0</span>)</div>
                                <div class="text-[10px] text-gray-500 mb-1">+Hiệu quả thiên phú</div>
                                <button onclick="upgradeDao('talent')" class="w-full bg-purple-900 hover:bg-purple-800 text-xs py-1 rounded border border-purple-700">
                                    Up (2000 Đá)
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 text-[10px] text-gray-400 italic" id="dao-desc"></div>
                    </div>

                    <div class="bg-gray-800/50 p-3 rounded border border-gray-700">
                        <h4 class="font-bold mb-2 flex justify-between" id="upg-root-header">
                            <span><i class="fa-solid fa-fire mr-1"></i> Linh Căn: <span id="upg-root-name">---</span></span>
                            <span class="text-xs text-white bg-gray-700 px-2 rounded">Lv.<span id="root-lv">0</span></span>
                        </h4>
                        <div class="text-xs text-gray-300 mb-2">
                            Hiệu quả: +<span id="root-bonus-pct">0</span>% Công/Bạo/Chân Thương, +<span id="root-bonus-flat">0</span> Sát thương nguyên tố.
                        </div>
                        <button onclick="upgradeRoot()" class="w-full py-2 bg-red-900 hover:bg-red-800 text-red-100 font-bold rounded border border-red-700 mb-2">
                            Nâng Cấp Linh Căn (Tốn <span id="root-cost">0</span> Đá)
                        </button>
                        
                        <div class="mt-2">
                            <div class="text-xs font-bold text-gray-400 mb-1">Thần Thông Đã Ngộ:</div>
                            <div id="root-skills-list" class="space-y-1"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const LOCAL_STORAGE_KEY = 'thien_dao_tu_tien_v1_4';
        const TICK_RATE_MS = 1000;
        
        // --- DATA DEFINITIONS ---

        const DAO_PATHS = {
            'kiem_tu': {
                name: 'Kiếm Tu', icon: 'fa-khanda', desc: 'Nhất kiếm phá vạn pháp',
                counter: 'ma_tu', weak: 'the_tu',
                baseStats: { attack: 300, attack_percent: 5, speed: 100, crit_rate: 5, crit_dmg: 10, vamp: 2, dodge_resist: 3 },
                talentStats: { attack_percent: 7, crit_dmg: 6, counter_resist: 5, dodge_resist: 2 },
                skill: 'Kiếm Vực: Khi vào trận 30% tăng 20% sát thương toàn đội (2 lượt).'
            },
            'the_tu': {
                name: 'Thể Tu', icon: 'fa-dumbbell', desc: 'Lấy thân luyện đạo',
                counter: 'kiem_tu', weak: 'ma_tu',
                baseStats: { hp_regen: 20, hp: 5000, defense: 300, hp_percent: 20, counter_rate: 2, vamp_resist: 10, crit_resist: 10, crit_dmg_resist: 3 },
                talentStats: { defense_percent: 10, hp_percent: 10, counter_rate: 6, vamp_resist: 3, crit_resist: 8, crit_dmg_resist: 5 },
                skill: 'Bất Hoại: Mỗi 3 lượt hồi 10% HP, phản đòn 150% thủ.'
            },
            'ma_tu': {
                name: 'Ma Tu', icon: 'fa-skull', desc: 'Đạo hóa ma tâm',
                counter: 'the_tu', weak: 'kiem_tu',
                baseStats: { hp: 3000, attack: 1200, defense: 500, hp_percent: 5, counter_rate: 5, vamp: 10, crit_resist: 5 },
                talentStats: { attack_percent: 10, defense_percent: 10, counter_rate: 5, vamp: 5, crit_resist: 3, crit_dmg_resist: 5 },
                skill: 'Hiến Tế: Vào trận giảm 50% thủ tăng 50% công (5 lượt).'
            },
            'than_tinh': {
                name: 'Thần Tinh', icon: 'fa-eye', desc: 'Nhìn thấu thiên cơ',
                counter: 'van_thanh', weak: 'dao_mon',
                baseStats: { cult_speed: 10, stone_drop: 5, hp: 50, attack: 500, speed: 300, speed_percent: 5, crit_rate: 5, dodge: 10 },
                talentStats: { cult_speed: 15, stone_drop: 10, speed: 50, speed_percent: 5, dodge_resist: 5 },
                skill: 'Thiên Cơ: Chí mạng có 30% giảm 50% né địch (2 lượt).'
            },
            'van_thanh': {
                name: 'Văn Thánh', icon: 'fa-scroll', desc: 'Bút hạ luận thiên hạ',
                counter: 'dao_mon', weak: 'than_tinh',
                baseStats: { cult_speed: 15, stone_drop: 15, defense_percent: 8, hp_percent: 8, dodge: 7, dmg_reduce: 5 },
                talentStats: { cult_speed: 10, stone_drop: 10, dmg_reduce: 8, cc_resist: 5 },
                skill: 'Hạo Nhiên Khí: Vào trận tăng 15% toàn chỉ số (3 lượt).'
            },
            'dao_mon': {
                name: 'Đạo Môn', icon: 'fa-yin-yang', desc: 'Luyện đan trừ tà',
                counter: 'than_tinh', weak: 'van_thanh',
                baseStats: { hp_regen: 10, attack_percent: 10, defense_percent: 12, hp_percent: 12, speed_percent: 3, dmg_reduce: 7 },
                talentStats: { attack_percent: 5, defense_percent: 5, hp_percent: 5, dmg_reduce: 3 },
                skill: 'Thái Cực: Mỗi 3 lượt tạo khiên 20% HP.'
            }
        };

        const SPIRIT_ROOTS = {
            'kim': { name: 'Kim', color: 'text-yellow-400', skillDesc: 'Tăng Xuyên Giáp & Bạo Kích' },
            'moc': { name: 'Mộc', color: 'text-green-400', skillDesc: 'Tăng Hồi Máu & Hút Huyết' },
            'thuy': { name: 'Thủy', color: 'text-blue-400', skillDesc: 'Tăng Khống Chế & Làm Chậm' },
            'hoa': { name: 'Hỏa', color: 'text-red-400', skillDesc: 'Tăng Sát Thương & Thiêu Đốt' },
            'tho': { name: 'Thổ', color: 'text-gray-400', skillDesc: 'Tăng Phòng Thủ & Phản Đòn' }
        };

        const ATTRIBUTES_DEF = [
            { id: 'body', name: 'Thể Phách', desc: 'Sinh lực, Kháng hút máu' },
            { id: 'strength', name: 'Lực Tay', desc: 'Tấn công, Bạo kích' },
            { id: 'bone', name: 'Căn Cốt', desc: 'Phòng thủ, Phản đòn' },
            { id: 'agility', name: 'Thân Pháp', desc: 'Tốc độ, Né tránh' }
        ];

        // --- STATE & UTILS ---
        let gameData = {};
        let gameLoopInterval = null;
        let tempSelection = { dao: null, root: null };

        function getMaxExp(level) {
            if (level >= 225) return 42000000000;
            const R = 1.0933405; 
            const exp = 100 * Math.pow(R, level - 1);
            if (exp > 1000000) return Math.floor(exp / 100000) * 100000;
            return Math.floor(exp);
        }

        // --- STAT CALCULATION ENGINE ---
        function calculateStats() {
            const p = gameData.player;
            const attr = p.attributes;
            const dao = DAO_PATHS[p.daoPath] || { baseStats: {}, talentStats: {} };
            const daoBaseLv = p.daoBaseLv || 0;
            const daoTalentLv = p.daoTalentLv || 0;

            // 1. Base Stats Init
            let stats = {
                hp: 100, hp_percent: 0, hp_regen: 0,
                attack: 10, attack_percent: 0,
                defense: 5, defense_percent: 0,
                speed: 10, speed_percent: 0,
                crit_rate: 0, crit_dmg: 150,
                vamp: 0, vamp_resist: 0,
                crit_resist: 0, crit_dmg_resist: 0,
                counter_rate: 0, counter_dmg: 0, counter_resist: 0,
                dodge: 0, dodge_resist: 0, accuracy: 100,
                combo: 0, combo_resist: 0,
                true_dmg_rate: 0, true_dmg_flat: 0,
                dmg_reduce: 0, cc_resist: 0,
                cult_speed: 0, stone_drop: 0,
                elem_dmg: 0 // Sát thương nguyên tố
            };

            // 2. Potential Points
            stats.hp += attr.body * 120;
            stats.hp_percent += attr.body * 0.06;
            stats.vamp_resist += attr.body * 0.03;

            stats.attack += attr.strength * 12;
            stats.crit_rate += attr.strength * 0.01;
            stats.crit_dmg += attr.strength * 0.03;

            stats.defense += attr.bone * 16;
            stats.hp += attr.bone * 20;
            stats.crit_resist += attr.bone * 0.01;
            stats.crit_dmg_resist += attr.bone * 0.03;
            stats.counter_rate += attr.bone * 0.04;
            stats.counter_dmg += attr.bone * 0.01;

            stats.speed += attr.agility * 6;
            stats.speed_percent += attr.agility * 0.05;
            stats.dodge += attr.agility * 0.04;
            stats.accuracy += attr.agility * 0.04;
            stats.combo += attr.agility * 0.02;
            stats.combo_resist += attr.agility * 0.02;

            // 3. Dao Path Base Stats (Scale with Upgrade Level)
            const baseMult = 1 + (daoBaseLv * 0.1); // Mỗi cấp tăng 10% chỉ số cơ bản đạo lộ
            for (let key in dao.baseStats) {
                if (stats[key] !== undefined) stats[key] += dao.baseStats[key] * baseMult;
            }

            // 4. Dao Path Talent Stats (Scale with Upgrade Level)
            const talentMult = 1 + (daoTalentLv * 0.05); // Mỗi cấp tăng 5%
            for (let key in dao.talentStats) {
                if (stats[key] !== undefined) stats[key] += dao.talentStats[key] * talentMult;
            }

            // 5. Spirit Root (Linh Căn)
            // Cấp 1 -> Cấp N: +1% Atk, 1% Crit, 1% TrueDmg, 300 ElemDmg
            const rLv = p.rootLevel || 0;
            stats.attack_percent += rLv * 1;
            stats.crit_rate += rLv * 1;
            stats.true_dmg_rate += rLv * 1;
            stats.elem_dmg += rLv * 300;

            // Thần Thông (Passive)
            if (rLv >= 5) {
                 // Ví dụ đơn giản: Cấp 5 tăng thêm 5% mọi chỉ số
                 stats.hp_percent += 5; stats.attack_percent += 5;
            }
            if (rLv >= 50) {
                 stats.dmg_reduce += 10;
            }

            // 6. Final Calculation
            stats.hp_final = Math.floor(stats.hp * (1 + stats.hp_percent / 100));
            stats.attack_final = Math.floor(stats.attack * (1 + stats.attack_percent / 100));
            stats.defense_final = Math.floor(stats.defense * (1 + stats.defense_percent / 100));
            stats.speed_final = Math.floor(stats.speed * (1 + stats.speed_percent / 100));

            // Cap stats
            if (stats.dodge > 50) stats.dodge = 50; // Trần 50% né

            return stats;
        }

        // --- GAME LOOP ---
        function startGameLoop() {
            if (gameLoopInterval) clearInterval(gameLoopInterval);
            gameLoopInterval = setInterval(gameTick, TICK_RATE_MS);
        }

        function gameTick() {
            const now = Date.now();
            const elapsed = Math.min(now - gameData.lastTick, 60000); 
            const multiplier = elapsed / TICK_RATE_MS;
            gameData.lastTick = now;

            const p = gameData.player;
            const stats = calculateStats();
            const currentMaxExp = getMaxExp(p.level);
            
            // EXP Gain logic
            let expBase = Math.ceil(currentMaxExp / 450); 
            if (expBase < 1) expBase = 1;
            // Bonus from Stats
            let finalExpGain = Math.floor(expBase * (1 + stats.cult_speed / 100) * multiplier);

            // Stone Gain
            let stoneBase = Math.floor(p.level / 3) + 1;
            let finalStoneGain = Math.floor(stoneBase * (1 + stats.stone_drop / 100) * multiplier);

            p.exp += finalExpGain;
            gameData.resources.spirit_stones += finalStoneGain;

            // Level Up
            let maxExp = getMaxExp(p.level);
            while (p.exp >= maxExp && p.level < 225) {
                p.exp -= maxExp;
                p.level++;
                p.potentialPoints += 10;
                maxExp = getMaxExp(p.level);
            }

            saveToLocalStorage();
            updateDynamicUI(finalExpGain, finalStoneGain);
        }

        // --- UI UPDATES ---
        function updateFullUI() {
            const p = gameData.player;
            // Check Selection
            if (!p.daoPath || !p.spiritRoot) {
                document.getElementById('modal-selection').classList.remove('hidden');
                renderSelectionModal();
                return;
            }
            updateDynamicUI(0,0);
        }

        function updateDynamicUI(expRate, stoneRate) {
            const p = gameData.player;
            const maxExp = getMaxExp(p.level);
            
            document.getElementById('display-name').innerText = p.name;
            const realmName = (Math.floor((p.level-1)/9) >= 25) ? "Siêu Thoát" : ["Luyện Khí","Trúc Cơ","Kim Đan","Nguyên Anh","Hóa Thần","Phản Hư","Hợp Thể","Đại Thừa","Độ Kiếp","Tiên Nhân","Chân Tiên","Kim Tiên","Thái Ất","Đại La","Hỗn Độn","Chí Tôn","Thiên Đạo","Vô Cực","Hư Vô","Hồng Mông","Đạo Tổ","Vô Tận","Chân Lý","Chưởng Nguyên","Siêu Thoát"][Math.floor((p.level-1)/9)] + " " + ["Nhất","Nhị","Tam","Tứ","Ngũ","Lục","Thất","Bát","Cửu"][(p.level-1)%9] + " Trọng";
            document.getElementById('display-realm').innerText = realmName;
            
            document.getElementById('display-stones').innerText = formatNumber(gameData.resources.spirit_stones);
            
            const percent = Math.min(100, (p.exp / maxExp) * 100);
            document.getElementById('exp-bar').style.width = `${percent}%`;
            document.getElementById('exp-text').innerText = `${formatNumber(p.exp)} / ${formatNumber(maxExp)}`;
            
            if(expRate > 0) document.getElementById('gain-rate-text').innerText = `(+${formatNumber(expRate)} EXP & +${formatNumber(stoneRate)} Linh thạch / giây)`;

            // Noti dot
            const notiChar = document.getElementById('noti-char');
            if (p.potentialPoints > 0) notiChar.classList.remove('hidden');
            else notiChar.classList.add('hidden');

            // Header Tooltip
            const daoInfo = DAO_PATHS[p.daoPath];
            const rootInfo = SPIRIT_ROOTS[p.spiritRoot];
            if (daoInfo) document.getElementById('tooltip-dao').innerHTML = `<i class="fa-solid ${daoInfo.icon} text-yellow-500"></i> ${daoInfo.name}`;
            if (rootInfo) document.getElementById('tooltip-root').innerHTML = `<i class="fa-solid fa-fire ${rootInfo.color}"></i> Linh Căn: ${rootInfo.name} (Lv.${p.rootLevel})`;

            // Update Modal Stats if open
            if (!document.getElementById('modal-character').classList.contains('hidden')) {
                renderAttributes();
                renderDetailedStats();
            }
        }

        // --- SELECTION MODAL LOGIC ---
        function renderSelectionModal() {
            const daoList = document.getElementById('dao-selection-list');
            const rootList = document.getElementById('root-selection-list');
            
            daoList.innerHTML = Object.keys(DAO_PATHS).map(key => {
                const d = DAO_PATHS[key];
                const isSelected = tempSelection.dao === key;
                return `
                <div onclick="selectDao('${key}')" class="p-3 border ${isSelected ? 'border-yellow-500 bg-gray-800' : 'border-gray-700 bg-gray-900'} rounded cursor-pointer hover:bg-gray-800 flex justify-between items-center transition">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-black flex items-center justify-center border border-gray-600"><i class="fa-solid ${d.icon} text-yellow-500"></i></div>
                        <div>
                            <div class="font-bold text-sm ${isSelected ? 'text-yellow-400' : 'text-gray-300'}">${d.name}</div>
                            <div class="text-[10px] text-gray-500">${d.desc}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            rootList.innerHTML = Object.keys(SPIRIT_ROOTS).map(key => {
                const r = SPIRIT_ROOTS[key];
                const isSelected = tempSelection.root === key;
                return `
                <div onclick="selectRoot('${key}')" class="p-3 border ${isSelected ? 'border-yellow-500 bg-gray-800' : 'border-gray-700 bg-gray-900'} rounded cursor-pointer hover:bg-gray-800 flex justify-between items-center transition">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-black flex items-center justify-center border border-gray-600"><i class="fa-solid fa-fire ${r.color}"></i></div>
                        <div>
                            <div class="font-bold text-sm ${isSelected ? 'text-yellow-400' : 'text-gray-300'}">${r.name}</div>
                            <div class="text-[10px] text-gray-500">${r.skillDesc}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            const btn = document.getElementById('btn-confirm-sel');
            if (tempSelection.dao && tempSelection.root) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-700', 'cursor-not-allowed', 'text-gray-400');
                btn.classList.add('bg-yellow-700', 'hover:bg-yellow-600', 'text-white');
            }
        }

        function selectDao(key) {
            tempSelection.dao = key;
            document.getElementById('sel-preview-dao').innerHTML = `Đạo: <span class="text-yellow-500 font-bold">${DAO_PATHS[key].name}</span>`;
            renderSelectionModal();
        }
        function selectRoot(key) {
            tempSelection.root = key;
            document.getElementById('sel-preview-root').innerHTML = `Căn: <span class="${SPIRIT_ROOTS[key].color} font-bold">${SPIRIT_ROOTS[key].name}</span>`;
            renderSelectionModal();
        }
        function confirmSelection() {
            if (!tempSelection.dao || !tempSelection.root) return;
            gameData.player.daoPath = tempSelection.dao;
            gameData.player.spiritRoot = tempSelection.root;
            gameData.player.rootLevel = 1;
            gameData.player.daoBaseLv = 0;
            gameData.player.daoTalentLv = 0;
            saveToLocalStorage();
            document.getElementById('modal-selection').classList.add('hidden');
            updateFullUI();
        }

        // --- UPGRADE LOGIC ---
        function upgradeDao(type) {
            const cost = type === 'base' ? 1000 : 2000;
            if (gameData.resources.spirit_stones >= cost) {
                gameData.resources.spirit_stones -= cost;
                if (type === 'base') gameData.player.daoBaseLv++;
                else gameData.player.daoTalentLv++;
                saveToLocalStorage();
                renderUpgradeTab();
                alert("Cường hóa thành công!");
            } else {
                alert("Không đủ Linh Thạch!");
            }
        }

        function upgradeRoot() {
            // Cost scale: 100 * level
            const currentLv = gameData.player.rootLevel || 1;
            const cost = currentLv * 100;
            if (gameData.resources.spirit_stones >= cost) {
                gameData.resources.spirit_stones -= cost;
                gameData.player.rootLevel++;
                saveToLocalStorage();
                renderUpgradeTab();
                alert("Nâng cấp Linh Căn thành công!");
            } else {
                alert(`Cần ${formatNumber(cost)} Linh Thạch!`);
            }
        }

        // --- CHARACTER MODAL RENDER ---
        function switchCharTab(tab) {
            document.getElementById('tab-content-info').classList.add('hidden');
            document.getElementById('tab-content-stats').classList.add('hidden');
            document.getElementById('tab-content-upgrade').classList.add('hidden');
            
            document.getElementById('tab-btn-info').className = "flex-1 py-3 text-sm font-bold text-gray-400";
            document.getElementById('tab-btn-stats').className = "flex-1 py-3 text-sm font-bold text-gray-400";
            document.getElementById('tab-btn-upgrade').className = "flex-1 py-3 text-sm font-bold text-gray-400";

            document.getElementById('tab-content-' + tab).classList.remove('hidden');
            document.getElementById('tab-btn-' + tab).className = "flex-1 py-3 text-sm font-bold text-yellow-500 border-b-2 border-yellow-500 bg-gray-800";

            if (tab === 'upgrade') renderUpgradeTab();
            if (tab === 'stats') renderDetailedStats();
            if (tab === 'info') renderAttributes();
        }

        function renderUpgradeTab() {
            const p = gameData.player;
            const dao = DAO_PATHS[p.daoPath];
            const root = SPIRIT_ROOTS[p.spiritRoot];

            // Render Dao
            document.getElementById('upg-dao-name').innerText = dao.name;
            const counterDao = DAO_PATHS[dao.counter];
            document.getElementById('upg-dao-counter').innerText = `${counterDao.name} (+20% ST)`;
            document.getElementById('dao-base-lv').innerText = p.daoBaseLv;
            document.getElementById('dao-talent-lv').innerText = p.daoTalentLv;
            document.getElementById('dao-desc').innerText = dao.desc + " | " + dao.skill;

            // Render Root
            document.getElementById('upg-root-name').innerText = root.name;
            document.getElementById('upg-root-header').className = `font-bold mb-2 flex justify-between ${root.color}`;
            document.getElementById('root-lv').innerText = p.rootLevel;
            document.getElementById('root-bonus-pct').innerText = p.rootLevel;
            document.getElementById('root-bonus-flat').innerText = p.rootLevel * 300;
            document.getElementById('root-cost').innerText = formatNumber(p.rootLevel * 100);

            // Skills
            let skillsHtml = '';
            if (p.rootLevel >= 5) skillsHtml += `<div class="text-[10px] text-green-400"><i class="fa-solid fa-check"></i> [Lv.5] Khai mở Linh Trí: +5% Toàn thuộc tính</div>`;
            else skillsHtml += `<div class="text-[10px] text-gray-600"><i class="fa-solid fa-lock"></i> [Lv.5] Khai mở Linh Trí</div>`;
            
            if (p.rootLevel >= 50) skillsHtml += `<div class="text-[10px] text-green-400"><i class="fa-solid fa-check"></i> [Lv.50] Hộ Thể Linh Quang: +10% Miễn thương</div>`;
            else skillsHtml += `<div class="text-[10px] text-gray-600"><i class="fa-solid fa-lock"></i> [Lv.50] Hộ Thể Linh Quang</div>`;

            document.getElementById('root-skills-list').innerHTML = skillsHtml;
        }

        function renderDetailedStats() {
            const stats = calculateStats();
            const container = document.getElementById('detailed-stats-container');
            
            const list = [
                { k: 'HP', v: formatNumber(stats.hp_final) },
                { k: 'Tấn Công', v: formatNumber(stats.attack_final) },
                { k: 'Phòng Thủ', v: formatNumber(stats.defense_final) },
                { k: 'Tốc Độ', v: formatNumber(stats.speed_final) },
                { k: 'ST Nguyên Tố', v: formatNumber(stats.elem_dmg) },
                { k: 'Chí Mạng', v: stats.crit_rate.toFixed(2) + '%' },
                { k: 'ST Bạo Kích', v: stats.crit_dmg.toFixed(2) + '%' },
                { k: 'Né Tránh', v: stats.dodge.toFixed(2) + '%' },
                { k: 'Chính Xác', v: stats.accuracy.toFixed(2) + '%' },
                { k: 'Hút Huyết', v: stats.vamp.toFixed(2) + '%' },
                { k: 'Chân Thương', v: stats.true_dmg_rate.toFixed(2) + '%' },
                { k: 'Phản Đòn', v: stats.counter_rate.toFixed(2) + '%' },
                { k: 'Miễn Thương', v: stats.dmg_reduce.toFixed(2) + '%' },
                { k: 'Tốc độ tu luyện', v: '+' + stats.cult_speed.toFixed(2) + '%' },
                { k: 'Thu hoạch Linh thạch', v: '+' + stats.stone_drop.toFixed(2) + '%' },
            ];

            container.innerHTML = list.map(i => `
                <div class="flex justify-between border-b border-gray-700 pb-1">
                    <span class="text-gray-400">${i.k}</span>
                    <span class="text-white font-bold">${i.v}</span>
                </div>
            `).join('');
        }

        function renderAttributes() {
            const container = document.getElementById('attributes-list');
            document.getElementById('val-potential').innerText = gameData.player.potentialPoints;
            container.innerHTML = ATTRIBUTES_DEF.map(attr => `
                <div class="bg-gray-800 p-2 rounded flex items-center justify-between border border-gray-700">
                    <div>
                        <div class="text-sm font-bold text-gray-200">${attr.name}</div>
                        <div class="text-[10px] text-gray-500">${attr.desc}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-yellow-500 font-mono font-bold text-lg">${gameData.player.attributes[attr.id]}</span>
                        <button onclick="addPoint('${attr.id}')" class="w-8 h-8 bg-blue-700 hover:bg-blue-600 rounded text-white flex items-center justify-center ${gameData.player.potentialPoints > 0 ? '' : 'opacity-50 cursor-not-allowed'}"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function addPoint(id) {
            if (gameData.player.potentialPoints > 0) {
                gameData.player.potentialPoints--;
                gameData.player.attributes[id]++;
                saveToLocalStorage();
                renderAttributes();
            }
        }

        // --- CORE & SAVE ---
        window.onload = function() { checkAutoSave(); };
        function checkAutoSave() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            document.getElementById('btn-continue').classList.toggle('hidden', !savedData);
        }
        function newGame() {
            if (localStorage.getItem(LOCAL_STORAGE_KEY) && !confirm("Tạo mới sẽ xóa dữ liệu cũ?")) return;
            initDefaultData();
            saveToLocalStorage();
            enterGame();
        }
        function continueGame() {
            try {
                const saved = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY));
                if (saved) { gameData = mergeData(saved); enterGame(); }
            } catch (e) { alert("File lỗi!"); initDefaultData(); }
        }
        function mergeData(old) {
            const def = initDefaultData(true);
            const merged = { ...def, ...old, player: { ...def.player, ...old.player, attributes: { ...def.player.attributes, ...(old.player.attributes || {}) } }, resources: { ...def.resources, ...old.resources } };
            // Ensure compatibility
            if(!merged.player.daoPath) merged.player.daoPath = null;
            return merged;
        }
        function initDefaultData(ret = false) {
            const d = { 
                player: { name: 'Vô Danh', level: 1, exp: 0, potentialPoints: 0, daoPath: null, spiritRoot: null, rootLevel: 1, daoBaseLv: 0, daoTalentLv: 0, attributes: { body: 0, strength: 0, bone: 0, agility: 0 } }, 
                resources: { spirit_stones: 0 }, lastTick: Date.now() 
            };
            if (ret) return d;
            gameData = d;
        }
        function saveToLocalStorage() { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(gameData)); }
        function enterGame() {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            gameData.lastTick = Date.now();
            updateFullUI();
            startGameLoop();
        }
        function returnToMenu() {
            clearInterval(gameLoopInterval);
            saveToLocalStorage();
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
            checkAutoSave();
        }
        function formatNumber(n) { return n >= 1e9 ? (n/1e9).toFixed(2)+' Tỷ' : n >= 1e6 ? (n/1e6).toFixed(2)+' Triệu' : n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
        function triggerFileInput() { document.getElementById('file-upload').click(); }
        function handleFileUpload(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload=e=>{try{gameData=mergeData(JSON.parse(e.target.result));saveToLocalStorage();enterGame();alert("Tải thành công!");}catch{alert("Lỗi file!");}}; r.readAsText(f); input.value=''; }
        function exportSaveFile() { const b = new Blob([JSON.stringify(gameData, null, 2)], {type:"application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `ThienDao_${Date.now()}.json`; a.click(); }
        function openCharacterModal() { renderAttributes(); renderDetailedStats(); document.getElementById('modal-character').classList.remove('hidden'); }
        function closeCharacterModal() { document.getElementById('modal-character').classList.add('hidden'); }
    </script>
</body>
</html>