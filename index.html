<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thiên Đạo Tu Tiên - Webgame Text RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #0f172a; color: #e2e8f0;
            background-image: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
        }
        .game-title { font-family: 'Cinzel', serif; text-shadow: 0 0 10px rgba(234, 179, 8, 0.5); }
        .meditating-img { animation: breathe 4s ease-in-out infinite; }
        @keyframes breathe { 0%, 100% { opacity: 0.9; transform: scale(1); } 50% { opacity: 1; transform: scale(1.02); box-shadow: 0 0 30px rgba(234, 179, 8, 0.4); } }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }

        /* Quality Colors */
        .q-0 { color: #9ca3af; } /* Phàm */
        .q-1 { color: #4ade80; } /* Khá */
        .q-2 { color: #60a5fa; } /* Tốt */
        .q-3 { color: #c084fc; } /* Hiếm */
        .q-4 { color: #facc15; } /* Truyền Thuyết */
        .q-5 { color: #ef4444; text-shadow: 0 0 5px red; } /* Thần */

        /* Toast & Combat Log */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: rgba(15, 23, 42, 0.95); border: 1px solid #475569; padding: 12px 20px; border-radius: 8px; color: white; animation: slideIn 0.3s ease-out; pointer-events: auto; max-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); font-size: 13px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .combat-log p { margin-bottom: 6px; border-bottom: 1px solid #1e293b; padding-bottom: 4px; line-height: 1.4; }
        .log-player { color: #4ade80; }
        .log-enemy { color: #f87171; }
        .log-info { color: #fbbf24; font-weight: bold; background: rgba(251, 191, 36, 0.1); padding: 5px; border-radius: 4px; text-align: center; }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <input type="file" id="file-upload" class="hidden" accept=".json" onchange="handleFileUpload(this)">
    <div id="toast-container"></div>

    <div id="main-menu" class="w-full max-w-md text-center space-y-8">
        <div class="space-y-2">
            <i class="fa-solid fa-yin-yang text-6xl text-yellow-500 animate-spin" style="animation-duration: 10s;"></i>
            <h1 class="text-4xl md:text-5xl font-bold text-yellow-500 game-title tracking-wider mt-4">THIÊN ĐẠO <br> <span class="text-white text-2xl md:text-3xl">TU TIÊN</span></h1>
        </div>
        <div class="flex flex-col gap-4 px-8">
            <button id="btn-continue" onclick="continueGame()" class="hidden py-3 bg-green-900 border border-green-700 text-green-100 rounded font-bold">Tiếp Tục</button>
            <button onclick="newGame()" class="py-3 bg-gray-800 border border-gray-600 hover:bg-gray-700 text-gray-200 rounded font-bold">Chơi Mới</button>
            <button onclick="triggerFileInput()" class="py-3 bg-blue-900 border border-blue-700 hover:bg-blue-800 text-blue-100 rounded font-bold">Tải Save</button>
        </div>
        <div class="text-xs text-gray-600 mt-8">Ver 1.7.0 - Fix Đạo Lộ & Tháp</div>
    </div>

    <div id="game-container" class="hidden w-full max-w-4xl h-[90vh] bg-gray-900 border border-gray-700 rounded-xl shadow-2xl relative overflow-hidden flex flex-col">
        <div class="bg-gray-800 p-2 border-b border-gray-700 flex justify-between items-center shadow-md z-10 text-xs md:text-sm">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-gray-700 border border-yellow-600 flex items-center justify-center text-yellow-500"><i class="fa-solid fa-user-ninja"></i></div>
                <div>
                    <div id="display-name" class="font-bold text-yellow-500">Vô Danh</div>
                    <div id="display-realm" class="text-cyan-300">Phàm Nhân</div>
                </div>
            </div>
             <div class="flex gap-4">
                <div class="text-blue-400" title="Linh Thạch"><i class="fa-solid fa-gem mr-1"></i><span id="display-stones">0</span></div>
                <div class="text-purple-400" title="Điểm Tháp"><i class="fa-solid fa-dungeon mr-1"></i><span id="display-tower-pts">0</span></div>
            </div>
            <div class="flex gap-1">
                <button onclick="exportSaveFile()" class="bg-green-800 text-white px-2 py-1 rounded">Lưu</button>
                <button onclick="returnToMenu()" class="bg-red-900 text-white px-2 py-1 rounded">Thoát</button>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] flex flex-col items-center justify-center">
            <div class="max-w-md w-full text-center space-y-6 relative z-10">
                <div class="relative w-48 h-48 mx-auto rounded-full border-4 border-yellow-600/50 overflow-hidden shadow-[0_0_30px_rgba(234,179,8,0.2)] bg-black">
                    <img src="https://i.pinimg.com/564x/c1/8d/19/c18d19606a928b9d4b0a7341b833c26d.jpg" class="w-full h-full object-cover meditating-img">
                </div>
                <div>
                    <h2 class="text-lg font-bold text-yellow-100">Đang Nhập Định Tu Hành...</h2>
                    <p class="text-xs text-cyan-400 animate-pulse mt-1">Tự động hấp thu linh khí & Tìm kiếm cơ duyên</p>
                    <p id="gain-rate-text" class="text-[10px] text-gray-500 mt-2"></p>
                </div>
                <div class="bg-gray-800 rounded-full h-5 w-full border border-gray-600 relative overflow-hidden shadow">
                    <div id="exp-bar" class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 transition-all duration-500" style="width: 0%"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white"><span id="exp-text">0 / 100</span></div>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 p-2 border-t border-gray-700 flex justify-center gap-2 z-20">
            <button onclick="openModal('character')" class="w-14 h-12 bg-gray-700 hover:bg-gray-600 rounded border border-gray-600 text-yellow-500 text-[9px] font-bold uppercase flex flex-col items-center justify-center relative">
                <i class="fa-solid fa-user-shield text-lg mb-1"></i>Nhân Vật
                <div id="noti-char" class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></div>
            </button>
            <button onclick="openModal('inventory')" class="w-14 h-12 bg-gray-700 hover:bg-gray-600 rounded border border-gray-600 text-blue-400 text-[9px] font-bold uppercase flex flex-col items-center justify-center relative">
                <i class="fa-solid fa-sack-dollar text-lg mb-1"></i>Túi Đồ
                <div id="noti-inv" class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></div>
            </button>
             <button onclick="openModal('blacksmith')" class="w-14 h-12 bg-gray-700 hover:bg-gray-600 rounded border border-gray-600 text-orange-400 text-[9px] font-bold uppercase flex flex-col items-center justify-center">
                <i class="fa-solid fa-hammer text-lg mb-1"></i>Thợ Rèn
            </button>
            <button onclick="openModal('tower')" class="w-14 h-12 bg-gray-700 hover:bg-gray-600 rounded border border-gray-600 text-purple-500 text-[9px] font-bold uppercase flex flex-col items-center justify-center">
                <i class="fa-solid fa-dungeon text-lg mb-1"></i>Tháp
            </button>
        </div>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-2 md:p-4">
        <div id="modal-content" class="bg-gray-900 w-full max-w-3xl h-[85vh] border border-gray-600 rounded-lg flex flex-col shadow-2xl relative overflow-hidden">
            </div>
    </div>

    <script>
        // --- CONFIG & DATA ---
        const LOCAL_STORAGE_KEY = 'thien_dao_v1_7';
        
        const DAO_PATHS = {
            'kiem_tu': { name: 'Kiếm Tu', desc: 'Nhất kiếm phá vạn pháp', bonusDesc: '+20% Sát thương, +5% Chí mạng', stats: { attack_percent: 20, crit_rate: 5 } },
            'the_tu': { name: 'Thể Tu', desc: 'Lấy thân luyện đạo', bonusDesc: '+25% Máu, +5% Phản đòn', stats: { hp_percent: 25, counter_rate: 5 } },
            'ma_tu': { name: 'Ma Tu', desc: 'Đạo hóa ma tâm', bonusDesc: '+10% Hút máu, +15% Công', stats: { vamp: 10, attack_percent: 15 } },
            'than_tinh': { name: 'Thần Tinh', desc: 'Mắt thấy chân lý', bonusDesc: '+10% Chí mạng, +10% Né tránh', stats: { crit_rate: 10, dodge: 10 } },
            'van_thanh': { name: 'Văn Thánh', desc: 'Bút hạ luận thiên hạ', bonusDesc: '+15% Miễn thương, +10% Tốc tu luyện', stats: { dmg_reduce: 15, cult_speed: 10 } },
            'dao_mon': { name: 'Đạo Môn', desc: 'Vẽ bùa niệm chú', bonusDesc: '+20% Thủ, +10% Máu', stats: { defense_percent: 20, hp_percent: 10 } }
        };

        const SPIRIT_ROOTS = {
            'kim': { name: 'Kim', color: 'text-yellow-400', desc: 'Chủ sát phạt', bonusDesc: '+300 Sát thương Kim, +5% Xuyên giáp' },
            'moc': { name: 'Mộc', color: 'text-green-400', desc: 'Chủ sinh cơ', bonusDesc: '+300 Hồi phục, +5% Máu' },
            'thuy': { name: 'Thủy', color: 'text-blue-400', desc: 'Chủ nhu hòa', bonusDesc: '+300 Sát thương Thủy, +5% Né' },
            'hoa': { name: 'Hỏa', color: 'text-red-400', desc: 'Chủ hủy diệt', bonusDesc: '+300 Sát thương Hỏa, +5% Công' },
            'tho': { name: 'Thổ', color: 'text-gray-400', desc: 'Chủ phòng ngự', bonusDesc: '+300 Thủ, +5% Kháng bạo' }
        };

        const GEM_TYPES = [
            { id: 'gem_atk', name: 'Hồng Ngọc', stat: 'attack', val: 50, desc: 'Công' },
            { id: 'gem_hp', name: 'Hoàng Ngọc', stat: 'hp', val: 500, desc: 'Máu' },
            { id: 'gem_def', name: 'Lam Ngọc', stat: 'defense', val: 25, desc: 'Thủ' },
            { id: 'gem_crit', name: 'Tử Ngọc', stat: 'crit_rate', val: 0.5, desc: 'Bạo%', isPct: true },
            { id: 'gem_speed', name: 'Thanh Ngọc', stat: 'speed', val: 10, desc: 'Tốc' }
        ];

        let gameData = {};
        let gameLoopInt = null;
        let selectedItem = null;

        // --- CORE FUNCTIONS ---
        function getMaxExp(lv) { return lv >= 225 ? 42000000000 : Math.floor(100 * Math.pow(1.0933405, lv - 1)); }

        function calculateStats(entity = 'player', enemyFloor = 0) {
            if (entity === 'enemy') {
                const mult = 1 + (enemyFloor * 0.15); 
                return {
                    hp: Math.floor(1500 * mult), maxHp: Math.floor(1500 * mult),
                    attack: Math.floor(80 * mult),
                    defense: Math.floor(20 * mult),
                    speed: Math.floor(20 + enemyFloor),
                    crit_rate: Math.min(30, enemyFloor * 0.2),
                    name: `Yêu Thú Tầng ${enemyFloor}`
                };
            }

            const p = gameData.player;
            // Base Stats
            let s = { attack: 100, hp: 1000, defense: 20, speed: 100, crit_rate: 0, crit_dmg: 150, vamp: 0, dmg_reduce: 0, cult_speed: 0 };
            
            // 1. Attributes
            s.hp += (p.attributes.body||0) * 120;
            s.attack += (p.attributes.strength||0) * 12;
            s.defense += (p.attributes.bone||0) * 16;
            s.speed += (p.attributes.agility||0) * 6;

            // 2. Dao Path & Spirit Root (Null Check)
            if (p.daoPath && DAO_PATHS[p.daoPath]) {
                const dStats = DAO_PATHS[p.daoPath].stats;
                Object.entries(dStats).forEach(([k,v]) => {
                    if (s[k] !== undefined) s[k] += v; // Flat addition for simplicity in pct
                    else s[k] = v;
                });
            }

            // 3. Equipments
            Object.values(p.equipped).forEach(it => {
                if(!it) return;
                const mul = (1 + it.enhanceLv*0.1) * (1 + it.starLv*0.2);
                Object.entries(it.baseStats).forEach(([k,v]) => s[k] = (s[k]||0) + Math.floor(v*mul));
                it.options.forEach(o => s[o.stat] = (s[o.stat]||0) + o.val);
                it.sockets.forEach(g => {
                    if(g) {
                        const baseInfo = GEM_TYPES.find(gt => gt.id === g.type);
                        if(baseInfo) {
                            const finalVal = baseInfo.val * g.level;
                            s[baseInfo.stat] = (s[baseInfo.stat]||0) + finalVal;
                        }
                    }
                });
            });

            // Handle Percentages (Simple logic)
            if(s.attack_percent) s.attack = Math.floor(s.attack * (1 + s.attack_percent/100));
            if(s.hp_percent) s.hp = Math.floor(s.hp * (1 + s.hp_percent/100));
            if(s.defense_percent) s.defense = Math.floor(s.defense * (1 + s.defense_percent/100));

            s.maxHp = s.hp;
            return s;
        }

        // --- GAME LOOP ---
        function startGameLoop() {
            if(gameLoopInt) clearInterval(gameLoopInt);
            gameLoopInt = setInterval(() => {
                const now = Date.now();
                const diff = Math.min(now - gameData.lastTick, 86400000) / 1000;
                gameData.lastTick = now;

                const p = gameData.player;
                const s = calculateStats();
                
                // Idle Gains
                const stoneGain = Math.floor((Math.floor(p.level/3)+1) * diff);
                gameData.resources.spirit_stones += stoneGain;
                
                const maxExp = getMaxExp(p.level);
                let expGain = Math.floor((maxExp / 450) * diff * (1 + (s.cult_speed||0)/100));
                if(expGain < 1) expGain = 1;
                p.exp += expGain;

                // Auto Drop
                if(Math.random() < 0.1 * diff) {
                    const drop = generateItem(p.level);
                    addItem(drop);
                    showToast(`Nhặt được: ${drop.name}`);
                }

                // Level Up
                while(p.exp >= maxExp && p.level < 225) {
                    p.exp -= maxExp; p.level++; p.potentialPoints += 10;
                    showToast(`Lên cấp: ${p.level}`, 'gold');
                }
                
                updateUI();
                saveData();
            }, 1000);
        }

        // --- ITEM GENERATION ---
        function generateItem(lv) {
            const rand = Math.random();
            if(rand < 0.2) {
                if(Math.random() < 0.5) {
                    const mats = ['stone_enhance','stone_refine','stone_star'];
                    const m = mats[Math.floor(Math.random()*mats.length)];
                    return { isEquip: false, type: 'material', id: m, name: (m==='stone_enhance'?'Đá Cường Hóa':m==='stone_refine'?'Đá Tẩy Luyện':'Đá Thăng Tinh'), count: 1, desc: 'Nguyên liệu' };
                } else {
                    const g = GEM_TYPES[Math.floor(Math.random()*GEM_TYPES.length)];
                    return { isEquip: false, type: 'gem', gemType: g.id, level: 1, name: `${g.name} Cấp 1`, count: 1, desc: `+${g.val} ${g.desc}` };
                }
            } else {
                const slots = ['than_binh','huyen_quan','linh_giap','huyen_quan_leg','than_hai','nhan_trai','nhan_phai','ngoc_boi'];
                const slot = slots[Math.floor(Math.random()*slots.length)];
                let q = 0;
                const qRand = Math.random();
                if(qRand < 0.005) q=5; else if(qRand < 0.02) q=4; else if(qRand < 0.1) q=3; else if(qRand < 0.3) q=2; else if(qRand < 0.6) q=1;
                
                const names = {'than_binh':'Kiếm','huyen_quan':'Mũ','linh_giap':'Áo','huyen_quan_leg':'Quần','than_hai':'Giày','nhan_trai':'Nhẫn','nhan_phai':'Nhẫn','ngoc_boi':'Ngọc'};
                const baseVal = lv * (q+1) * 3;
                
                let stats = {};
                if(slot.includes('binh') || slot.includes('nhan')) stats.attack = baseVal;
                else if(slot.includes('giap') || slot.includes('leg')) stats.hp = baseVal * 12;
                else stats.defense = Math.floor(baseVal / 2);

                let opts = [];
                for(let i=0; i<=q; i++) {
                    const types = ['attack','hp','defense','crit_rate','speed'];
                    const t = types[Math.floor(Math.random()*types.length)];
                    opts.push({ stat: t, val: Math.floor(baseVal * 0.25) });
                }

                return {
                    id: Date.now() + Math.random(), isEquip: true, type: slot, quality: q, level: lv,
                    name: `[${['Phàm','Khá','Tốt','Hiếm','Thuyết','Thần'][q]}] ${names[slot]}`,
                    baseStats: stats, options: opts, enhanceLv: 0, starLv: 0, sockets: [null,null,null]
                };
            }
        }

        function addItem(item) {
            if(item.isEquip) gameData.inventory.equips.push(item);
            else {
                const ex = gameData.inventory.items.find(i => 
                    i.type === item.type && i.id === item.id && (item.type !== 'gem' || i.gemType === item.gemType && i.level === item.level)
                );
                if(ex) ex.count += item.count;
                else gameData.inventory.items.push(item);
            }
        }

        // --- UI UPDATES ---
        function updateUI() {
            const p = gameData.player;
            document.getElementById('display-name').innerText = p.name;
            document.getElementById('display-stones').innerText = p.resources.spirit_stones.toLocaleString();
            document.getElementById('display-tower-pts').innerText = (gameData.tower?.points || 0).toLocaleString();
            
            const max = getMaxExp(p.level);
            document.getElementById('exp-bar').style.width = Math.min(100, (p.exp/max)*100) + '%';
            document.getElementById('exp-text').innerText = `${p.exp.toLocaleString()} / ${max.toLocaleString()}`;

            document.getElementById('noti-inv').className = gameData.inventory.equips.length > 0 ? "absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full" : "hidden";
        }

        function showToast(msg, type='norm') {
            const t = document.getElementById('toast-container');
            const d = document.createElement('div');
            d.className = `toast border-l-4 ${type==='gold'?'border-yellow-500':'border-blue-500'}`;
            d.innerText = msg;
            t.appendChild(d);
            setTimeout(() => d.remove(), 3000);
        }

        function openModal(type) {
            document.getElementById('modal-overlay').classList.remove('hidden');
            const content = document.getElementById('modal-content');
            content.innerHTML = '';
            if(type === 'character') renderCharacter(content);
            else if(type === 'inventory') renderInventory(content);
            else if(type === 'blacksmith') renderBlacksmith(content);
            else if(type === 'tower') renderTower(content);
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        // --- CHARACTER MODAL (NEW: SELECT DAO/ROOT) ---
        function renderCharacter(c) {
            const p = gameData.player;
            const hasDao = p.daoPath && DAO_PATHS[p.daoPath];
            const hasRoot = p.spiritRoot && SPIRIT_ROOTS[p.spiritRoot];

            c.innerHTML = `
                <div class="p-3 bg-gray-800 flex justify-between items-center border-b border-gray-700">
                    <h3 class="font-bold text-yellow-500">NHÂN VẬT</h3>
                    <button onclick="closeModal()"><i class="fa-solid fa-times text-gray-400"></i></button>
                </div>
                <div class="flex border-b border-gray-700">
                    <button onclick="renderCharTab('stats')" id="btn-char-stats" class="flex-1 py-2 text-sm font-bold bg-gray-700 text-yellow-500">Thuộc Tính</button>
                    <button onclick="renderCharTab('dao')" id="btn-char-dao" class="flex-1 py-2 text-sm font-bold bg-gray-800 text-gray-400">Đạo & Căn</button>
                </div>
                <div id="char-content" class="flex-1 overflow-y-auto p-4 custom-scroll"></div>
            `;
            renderCharTab('stats');
        }

        function renderCharTab(tab) {
            const content = document.getElementById('char-content');
            document.getElementById('btn-char-stats').className = `flex-1 py-2 text-sm font-bold ${tab==='stats'?'bg-gray-700 text-yellow-500':'bg-gray-800 text-gray-400'}`;
            document.getElementById('btn-char-dao').className = `flex-1 py-2 text-sm font-bold ${tab==='dao'?'bg-gray-700 text-yellow-500':'bg-gray-800 text-gray-400'}`;
            
            if (tab === 'stats') {
                const s = calculateStats();
                content.innerHTML = `
                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-300">
                        <div class="bg-gray-800 p-2 rounded">Máu: <span class="text-white">${s.maxHp}</span></div>
                        <div class="bg-gray-800 p-2 rounded">Công: <span class="text-white">${s.attack}</span></div>
                        <div class="bg-gray-800 p-2 rounded">Thủ: <span class="text-white">${s.defense}</span></div>
                        <div class="bg-gray-800 p-2 rounded">Tốc: <span class="text-white">${s.speed}</span></div>
                        <div class="bg-gray-800 p-2 rounded">Chí Mạng: <span class="text-white">${s.crit_rate}%</span></div>
                        <div class="bg-gray-800 p-2 rounded">Hút Máu: <span class="text-white">${s.vamp}%</span></div>
                    </div>
                `;
            } else {
                // Dao & Root Selection/Info
                const p = gameData.player;
                if (!p.daoPath || !p.spiritRoot) {
                    content.innerHTML = `<h4 class="text-center text-white mb-4">CHỌN CON ĐƯỜNG TU LUYỆN</h4>`;
                    
                    // Dao Selector
                    content.innerHTML += `<div class="mb-4"><h5 class="text-yellow-500 font-bold mb-2">Đạo Lộ</h5><div class="grid grid-cols-2 gap-2">`;
                    Object.entries(DAO_PATHS).forEach(([k, v]) => {
                         content.innerHTML += `<div onclick="chooseDao('${k}')" class="bg-gray-800 p-2 rounded border border-gray-600 hover:border-yellow-500 cursor-pointer ${p.daoPath===k?'border-yellow-500':''}">
                            <div class="font-bold text-sm">${v.name}</div>
                            <div class="text-[10px] text-gray-400">${v.bonusDesc}</div>
                         </div>`;
                    });
                    content.innerHTML += `</div></div>`;

                    // Root Selector
                    content.innerHTML += `<div class="mb-4"><h5 class="text-blue-500 font-bold mb-2">Linh Căn</h5><div class="grid grid-cols-2 gap-2">`;
                    Object.entries(SPIRIT_ROOTS).forEach(([k, v]) => {
                         content.innerHTML += `<div onclick="chooseRoot('${k}')" class="bg-gray-800 p-2 rounded border border-gray-600 hover:border-blue-500 cursor-pointer ${p.spiritRoot===k?'border-blue-500':''}">
                            <div class="font-bold text-sm ${v.color}">${v.name}</div>
                            <div class="text-[10px] text-gray-400">${v.bonusDesc}</div>
                         </div>`;
                    });
                    content.innerHTML += `</div></div>`;
                    
                    content.innerHTML += `<button onclick="saveDaoChoice()" class="w-full bg-green-700 py-2 rounded font-bold text-white mt-2">XÁC NHẬN CHỌN</button>`;
                } else {
                    // Show Info
                    const d = DAO_PATHS[p.daoPath];
                    const r = SPIRIT_ROOTS[p.spiritRoot];
                    content.innerHTML = `
                        <div class="bg-gray-800 p-4 rounded mb-4 border border-yellow-600">
                            <h3 class="text-xl font-bold text-yellow-500 mb-2">${d.name}</h3>
                            <p class="text-gray-300 italic mb-2">"${d.desc}"</p>
                            <div class="text-green-400 text-sm font-bold">Hiệu quả: ${d.bonusDesc}</div>
                        </div>
                        <div class="bg-gray-800 p-4 rounded border border-blue-600">
                            <h3 class="text-xl font-bold ${r.color} mb-2">${r.name} Linh Căn</h3>
                            <p class="text-gray-300 italic mb-2">"${r.desc}"</p>
                            <div class="text-green-400 text-sm font-bold">Hiệu quả: ${r.bonusDesc}</div>
                        </div>
                    `;
                }
            }
        }

        let tempDao = null;
        let tempRoot = null;
        function chooseDao(k) { tempDao = k; gameData.player.daoPath = k; renderCharTab('dao'); }
        function chooseRoot(k) { tempRoot = k; gameData.player.spiritRoot = k; renderCharTab('dao'); }
        function saveDaoChoice() {
            if(gameData.player.daoPath && gameData.player.spiritRoot) {
                saveData();
                showToast("Đã chọn Đạo & Căn!", "gold");
                renderCharTab('dao');
            } else {
                showToast("Vui lòng chọn cả hai!");
            }
        }

        // --- INVENTORY ---
        function renderInventory(c) {
            c.innerHTML = `
                <div class="p-3 bg-gray-800 flex justify-between items-center border-b border-gray-700">
                    <h3 class="font-bold text-blue-400">TÚI ĐỒ</h3>
                    <button onclick="closeModal()"><i class="fa-solid fa-times text-gray-400"></i></button>
                </div>
                <div class="flex border-b border-gray-700">
                    <button onclick="renderInvList(true)" class="flex-1 py-2 text-sm font-bold bg-gray-700 text-white">Trang Bị</button>
                    <button onclick="renderInvList(false)" class="flex-1 py-2 text-sm font-bold bg-gray-800 text-gray-400">Vật Phẩm</button>
                </div>
                <div class="p-2 bg-gray-800 flex gap-2 overflow-x-auto text-[10px]">
                    <span class="text-gray-400 py-1">Bán Nhanh:</span>
                    <button onclick="bulkSell(0)" class="px-2 py-1 bg-gray-600 rounded">Phàm</button>
                    <button onclick="bulkSell(1)" class="px-2 py-1 bg-green-900 rounded text-green-200">Khá</button>
                    <button onclick="bulkSell(2)" class="px-2 py-1 bg-blue-900 rounded text-blue-200">Tốt</button>
                </div>
                <div id="inv-list" class="flex-1 overflow-y-auto p-2 grid grid-cols-5 gap-2 content-start custom-scroll"></div>
                <div id="inv-detail" class="h-32 bg-gray-800 border-t border-gray-700 p-2 text-xs"></div>
            `;
            renderInvList(true);
        }

        function renderInvList(isEquip) {
            const list = document.getElementById('inv-list');
            list.innerHTML = '';
            const arr = isEquip ? gameData.inventory.equips : gameData.inventory.items;
            arr.forEach((it, idx) => {
                const color = isEquip ? `q-${it.quality}` : 'text-white';
                list.innerHTML += `
                <div onclick="selectInvItem(${idx}, ${isEquip})" class="aspect-square bg-gray-900 border border-gray-700 rounded hover:border-yellow-500 cursor-pointer flex flex-col items-center justify-center relative p-1">
                    <i class="fa-solid ${isEquip ? 'fa-shield-halved' : (it.type==='gem'?'fa-gem':'fa-cubes')} text-xl ${color}"></i>
                    <div class="text-[9px] truncate w-full text-center mt-1 ${color}">${it.name}</div>
                    ${!isEquip ? `<div class="absolute bottom-0 right-1 text-[9px]">x${it.count}</div>` : ''}
                </div>`;
            });
        }

        function selectInvItem(idx, isEquip) {
            const it = isEquip ? gameData.inventory.equips[idx] : gameData.inventory.items[idx];
            const d = document.getElementById('inv-detail');
            if(isEquip) {
                let stats = Object.entries(it.baseStats).map(([k,v]) => `${k}: +${v}`).join(', ');
                d.innerHTML = `
                    <div class="flex gap-2 h-full">
                        <div class="w-20 bg-gray-900 border border-gray-600 flex items-center justify-center"><i class="fa-solid fa-shield-halved text-4xl q-${it.quality}"></i></div>
                        <div class="flex-1 overflow-y-auto">
                            <div class="font-bold q-${it.quality}">${it.name} (+${it.enhanceLv})</div>
                            <div class="text-gray-400">${stats}</div>
                        </div>
                        <div class="flex flex-col gap-1 justify-center">
                            <button onclick="doEquip(${idx})" class="bg-green-700 text-white px-3 py-1 rounded">Mặc</button>
                            <button onclick="doSellOne(${idx})" class="bg-red-800 text-white px-3 py-1 rounded">Bán</button>
                        </div>
                    </div>`;
            } else {
                d.innerHTML = `
                    <div class="flex gap-2 h-full">
                         <div class="w-20 bg-gray-900 border border-gray-600 flex items-center justify-center"><i class="fa-solid ${it.type==='gem'?'fa-gem':'fa-cubes'} text-4xl text-white"></i></div>
                         <div class="flex-1">
                            <div class="font-bold text-white">${it.name}</div>
                            <div class="italic text-gray-400">${it.desc}</div>
                        </div>
                    </div>`;
            }
        }
        function bulkSell(q) {
            const oldLen = gameData.inventory.equips.length;
            gameData.inventory.equips = gameData.inventory.equips.filter(it => it.quality !== q);
            const sold = oldLen - gameData.inventory.equips.length;
            if(sold > 0) {
                gameData.resources.spirit_stones += sold * (q+1) * 100;
                showToast(`Đã bán ${sold} trang bị`);
                renderInvList(true);
            }
        }
        function doEquip(idx) {
            const item = gameData.inventory.equips[idx];
            const slot = item.type;
            const old = gameData.player.equipped[slot];
            gameData.player.equipped[slot] = item;
            gameData.inventory.equips.splice(idx, 1);
            if(old) gameData.inventory.equips.push(old);
            showToast("Đã trang bị!");
            renderInvList(true);
        }
        function doSellOne(idx) {
            const item = gameData.inventory.equips[idx];
            gameData.resources.spirit_stones += (item.quality+1)*100;
            gameData.inventory.equips.splice(idx, 1);
            renderInvList(true);
            document.getElementById('inv-detail').innerHTML = '';
        }

        // --- BLACKSMITH ---
        function renderBlacksmith(c) {
            c.innerHTML = `
                <div class="p-3 bg-gray-800 flex justify-between items-center border-b border-gray-700">
                    <h3 class="font-bold text-orange-400">THỢ RÈN</h3>
                    <button onclick="closeModal()"><i class="fa-solid fa-times text-gray-400"></i></button>
                </div>
                <div class="flex h-full">
                    <div class="w-1/4 bg-gray-800 border-r border-gray-700 p-2 space-y-2">
                        <button onclick="renderGemFuse()" class="w-full text-left p-2 bg-gray-700 rounded text-sm hover:bg-gray-600">Ghép Ngọc</button>
                    </div>
                    <div id="bs-content" class="flex-1 p-4 bg-gray-900 flex flex-col items-center justify-center"></div>
                </div>
            `;
            renderGemFuse();
        }

        function renderGemFuse() {
            const gems = gameData.inventory.items.filter(i => i.type === 'gem');
            let html = '<h4 class="text-yellow-500 font-bold mb-4">GHÉP NGỌC (3 viên -> 1 viên cấp cao)</h4><div class="grid grid-cols-4 gap-2 w-full">';
            gems.sort((a,b) => (a.gemType+a.level).localeCompare(b.gemType+b.level));
            gems.forEach(g => {
                const canFuse = g.count >= 3 && g.level < 10;
                const base = GEM_TYPES.find(x => x.id === g.gemType);
                const statVal = base.val * g.level;
                html += `
                <div class="bg-gray-800 p-2 rounded border border-gray-600 flex flex-col items-center relative">
                    <i class="fa-solid fa-gem text-2xl mb-1 ${base.id.includes('atk')?'text-red-400':base.id.includes('hp')?'text-yellow-400':'text-blue-400'}"></i>
                    <div class="text-xs font-bold text-center">${g.name}</div>
                    <div class="text-[9px] text-gray-400">+${statVal} ${base.desc}</div>
                    <div class="text-xs mt-1">SL: ${g.count}</div>
                    ${canFuse ? `<button onclick="doFuse('${g.id}', ${g.level}, '${g.gemType}')" class="mt-2 bg-green-700 text-white text-[10px] px-2 py-1 rounded w-full">Ghép</button>` : ''}
                </div>`;
            });
            document.getElementById('bs-content').innerHTML = html + '</div>';
        }

        function doFuse(itemId, lv, type) {
            const it = gameData.inventory.items.find(i => i.type === 'gem' && i.gemType === type && i.level === lv);
            if(it && it.count >= 3) {
                it.count -= 3;
                if(it.count === 0) gameData.inventory.items = gameData.inventory.items.filter(i => i !== it);
                const nextLv = lv + 1;
                const baseName = GEM_TYPES.find(x => x.id === type).name;
                const baseDesc = GEM_TYPES.find(x => x.id === type).desc;
                const baseVal = GEM_TYPES.find(x => x.id === type).val * nextLv;
                addItem({ isEquip: false, type: 'gem', gemType: type, level: nextLv, name: `${baseName} Cấp ${nextLv}`, count: 1, desc: `+${baseVal} ${baseDesc}` });
                showToast("Ghép ngọc thành công!", 'gold');
                renderGemFuse();
            }
        }

        // --- TOWER ---
        function renderTower(c) {
            c.innerHTML = `
                <div class="p-3 bg-gray-800 flex justify-between items-center border-b border-gray-700">
                    <h3 class="font-bold text-purple-400">THÁP VÔ TẬN</h3>
                    <button onclick="closeModal()"><i class="fa-solid fa-times text-gray-400"></i></button>
                </div>
                <div class="flex-1 flex flex-col p-4">
                    <div class="text-center mb-6">
                        <div class="text-4xl font-bold text-white mb-2">Tầng ${gameData.tower.floor}</div>
                        <div class="text-gray-400">Chiến đấu để nhận Điểm Tháp & Linh Thạch</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <button onclick="startTowerCombat()" class="bg-red-900 hover:bg-red-800 text-white font-bold py-4 rounded border border-red-600 text-xl">KHIÊU CHIẾN</button>
                        <button onclick="renderTowerShop()" class="bg-purple-900 hover:bg-purple-800 text-white font-bold py-4 rounded border border-purple-600 text-xl">TIỆM THÁP</button>
                    </div>
                    <div id="combat-log" class="flex-1 bg-black border border-gray-700 rounded p-2 overflow-y-auto font-mono text-xs combat-log hidden"></div>
                </div>
            `;
        }

        function renderTowerShop() {
             const c = document.getElementById('modal-content');
             c.innerHTML = `
                 <div class="p-3 bg-gray-800 flex justify-between items-center border-b border-gray-700">
                    <h3 class="font-bold text-purple-400">TIỆM THÁP (${gameData.tower.points})</h3>
                    <button onclick="openModal('tower')"><i class="fa-solid fa-arrow-left text-gray-400"></i></button>
                </div>
                <div class="p-4 grid grid-cols-3 gap-2">
                    ${GEM_TYPES.map(g => `
                        <div class="bg-gray-800 p-2 border border-gray-600 rounded flex flex-col items-center">
                            <div class="font-bold text-sm text-white">${g.name} Cấp 1</div>
                            <div class="text-xs text-gray-400">+${g.val} ${g.desc}</div>
                            <button onclick="buyGem('${g.id}')" class="mt-2 bg-yellow-700 px-3 py-1 rounded text-xs text-white">Mua (100 Điểm)</button>
                        </div>
                    `).join('')}
                </div>`;
        }
        function buyGem(type) {
            if(gameData.tower.points >= 100) {
                gameData.tower.points -= 100;
                const g = GEM_TYPES.find(x => x.id === type);
                addItem({ isEquip: false, type: 'gem', gemType: type, level: 1, name: `${g.name} Cấp 1`, count: 1, desc: `+${g.val} ${g.desc}` });
                showToast("Mua thành công!");
                renderTowerShop();
            } else showToast("Không đủ điểm!");
        }

        async function startTowerCombat() {
            const log = document.getElementById('combat-log');
            log.classList.remove('hidden');
            log.innerHTML = '<p class="text-center text-white">--- TRẬN CHIẾN BẮT ĐẦU ---</p>';
            let pStats = calculateStats('player');
            let eStats = calculateStats('enemy', gameData.tower.floor);
            
            let turn = 1;
            while(pStats.hp > 0 && eStats.hp > 0) {
                await new Promise(r => setTimeout(r, 600)); 
                const pDmg = Math.max(1, pStats.attack - eStats.defense);
                eStats.hp -= pDmg;
                log.innerHTML += `<p class="log-player">T${turn}: Bạn đánh ${eStats.name} -${pDmg} HP. (Địch: ${eStats.hp})</p>`;
                log.scrollTop = log.scrollHeight;
                if(eStats.hp <= 0) break;

                const eDmg = Math.max(1, eStats.attack - pStats.defense);
                pStats.hp -= eDmg;
                log.innerHTML += `<p class="log-enemy">T${turn}: Địch đánh bạn -${eDmg} HP. (Bạn: ${pStats.hp})</p>`;
                log.scrollTop = log.scrollHeight;
                turn++;
            }

            if(pStats.hp > 0) {
                const pts = 10 + Math.floor(gameData.tower.floor/10);
                const stones = 50 + gameData.tower.floor * 5;
                gameData.tower.floor++; gameData.tower.points += pts; gameData.resources.spirit_stones += stones;
                log.innerHTML += `<p class="log-info">THẮNG! +${pts} Điểm, +${stones} Linh Thạch</p>`;
                saveData();
            } else {
                log.innerHTML += `<p class="text-red-500 font-bold text-center mt-2">THẤT BẠI!</p>`;
            }
            log.scrollTop = log.scrollHeight;
        }

        // --- INIT ---
        window.onload = function() {
            if(localStorage.getItem(LOCAL_STORAGE_KEY)) document.getElementById('btn-continue').classList.remove('hidden');
        };

        function initData() {
            gameData = {
                player: { name: 'Vô Danh', level: 1, exp: 0, potentialPoints: 0, equipped: {}, attributes: {}, daoPath: null, spiritRoot: null },
                resources: { spirit_stones: 0 },
                inventory: { equips: [], items: [] },
                tower: { floor: 1, points: 0 },
                lastTick: Date.now()
            };
        }

        function newGame() {
            if(localStorage.getItem(LOCAL_STORAGE_KEY) && !confirm("Xóa dữ liệu cũ?")) return;
            initData();
            enterGame();
        }

        function continueGame() {
            try {
                const saved = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY));
                gameData = saved;
                if(!gameData.tower) gameData.tower = { floor: 1, points: 0 };
                enterGame();
            } catch(e) { initData(); newGame(); }
        }

        function enterGame() {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            updateUI();
            startGameLoop();
        }

        function returnToMenu() {
            clearInterval(gameLoopInt);
            saveData();
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
        }

        function saveData() { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(gameData)); }
        function triggerFileInput() { document.getElementById('file-upload').click(); }
        function handleFileUpload(input) { const f = input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ gameData=JSON.parse(e.target.result); saveData(); enterGame(); }; r.readAsText(f); }
        function exportSaveFile() { const b = new Blob([JSON.stringify(gameData)], {type:"application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'save.json'; a.click(); }
    </script>
</body>
</html>