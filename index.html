<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thiên Đạo Tu Tiên - Webgame Text RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #0f172a; color: #e2e8f0;
            background-image: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
        }
        .game-title { font-family: 'Cinzel', serif; text-shadow: 0 0 10px rgba(234, 179, 8, 0.5); }
        .meditating-img { animation: breathe 4s ease-in-out infinite; }
        @keyframes breathe { 0%, 100% { opacity: 0.9; transform: scale(1); } 50% { opacity: 1; transform: scale(1.02); box-shadow: 0 0 30px rgba(234, 179, 8, 0.4); } }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }

        /* Quality Colors */
        .q-0 { color: #9ca3af; } /* Phàm - Gray */
        .q-1 { color: #4ade80; } /* Khá - Green */
        .q-2 { color: #60a5fa; } /* Tốt - Blue */
        .q-3 { color: #c084fc; } /* Hiếm - Purple */
        .q-4 { color: #facc15; } /* Truyền Thuyết - Yellow */
        .q-5 { color: #ef4444; text-shadow: 0 0 5px red; } /* Thần - Red */

        /* Toast Notification */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: rgba(15, 23, 42, 0.95); border: 1px solid #475569; padding: 12px 20px; border-radius: 8px; color: white; animation: slideIn 0.3s ease-out; pointer-events: auto; max-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); font-size: 13px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <input type="file" id="file-upload" class="hidden" accept=".json" onchange="handleFileUpload(this)">
    
    <div id="toast-container"></div>

    <div id="main-menu" class="w-full max-w-md text-center space-y-8">
        <div class="space-y-2">
            <i class="fa-solid fa-yin-yang text-6xl text-yellow-500 animate-spin" style="animation-duration: 10s;"></i>
            <h1 class="text-4xl md:text-5xl font-bold text-yellow-500 game-title tracking-wider mt-4">THIÊN ĐẠO <br> <span class="text-white text-2xl md:text-3xl">TU TIÊN</span></h1>
        </div>
        <div class="flex flex-col gap-4 px-8">
            <button id="btn-continue" onclick="continueGame()" class="hidden py-3 bg-green-900 border border-green-700 text-green-100 rounded font-bold">Tiếp Tục</button>
            <button onclick="newGame()" class="py-3 bg-gray-800 border border-gray-600 hover:bg-gray-700 text-gray-200 rounded font-bold">Chơi Mới</button>
            <button onclick="triggerFileInput()" class="py-3 bg-blue-900 border border-blue-700 hover:bg-blue-800 text-blue-100 rounded font-bold">Tải Save</button>
        </div>
        <div class="text-xs text-gray-600 mt-8">Ver 1.5.0 - Túi Đồ & Thợ Rèn</div>
    </div>

    <div id="game-container" class="hidden w-full max-w-4xl h-[90vh] bg-gray-900 border border-gray-700 rounded-xl shadow-2xl relative overflow-hidden flex flex-col">
        <div class="bg-gray-800 p-4 border-b border-gray-700 flex flex-wrap justify-between items-center shadow-md z-10 gap-2">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gray-700 border border-yellow-600 flex items-center justify-center text-yellow-500"><i class="fa-solid fa-user-ninja"></i></div>
                <div>
                    <div id="display-name" class="font-bold text-yellow-500 leading-tight truncate w-24">Vô Danh</div>
                    <div id="display-realm" class="text-xs text-cyan-300 font-bold truncate w-24">Phàm Nhân</div>
                </div>
            </div>
             <div class="flex items-center gap-4 bg-gray-900 px-3 py-1 rounded border border-gray-700">
                <div class="flex items-center text-blue-400 text-sm font-bold"><span class="mr-2 text-gray-400 text-xs uppercase">Linh Thạch:</span><span id="display-stones">0</span></div>
            </div>
            <div class="flex gap-2">
                <button onclick="exportSaveFile()" class="text-xs bg-green-800 text-white px-3 py-1 rounded border border-green-600">Lưu</button>
                <button onclick="returnToMenu()" class="text-xs bg-red-900 text-white px-3 py-1 rounded border border-red-700">Thoát</button>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] relative flex flex-col items-center justify-center">
            <div class="max-w-md w-full text-center space-y-6 relative z-10">
                <div class="relative w-64 h-64 mx-auto rounded-full border-4 border-yellow-600/50 overflow-hidden shadow-[0_0_30px_rgba(234,179,8,0.2)] bg-black">
                    <img src="https://i.pinimg.com/564x/c1/8d/19/c18d19606a928b9d4b0a7341b833c26d.jpg" class="w-full h-full object-cover meditating-img">
                </div>
                <div>
                    <h2 class="text-xl font-bold text-yellow-100">Đang Nhập Định Tu Hành...</h2>
                    <p class="text-sm text-cyan-400 animate-pulse mt-1">Tự động hấp thu Thiên Địa Linh Khí & Tìm kiếm cơ duyên</p>
                    <p id="gain-rate-text" class="text-xs text-gray-500 mt-2"></p>
                </div>
                <div class="bg-gray-800 rounded-full h-6 w-full border border-gray-600 relative overflow-hidden shadow">
                    <div id="exp-bar" class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 transition-all duration-500 ease-out" style="width: 0%"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white"><span id="exp-text">0 / 100</span></div>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 p-2 border-t border-gray-700 flex justify-center gap-4 z-20">
            <button onclick="openModal('character')" class="flex flex-col items-center justify-center w-16 h-14 bg-gray-700 hover:bg-gray-600 rounded border border-gray-600 text-yellow-500 text-[10px] font-bold uppercase relative">
                <i class="fa-solid fa-user-shield text-xl mb-1"></i>Nhân Vật
                <div id="noti-char" class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></div>
            </button>
            <button onclick="openModal('inventory')" class="flex flex-col items-center justify-center w-16 h-14 bg-gray-700 hover:bg-gray-600 rounded border border-gray-600 text-blue-400 text-[10px] font-bold uppercase relative">
                <i class="fa-solid fa-sack-dollar text-xl mb-1"></i>Túi Đồ
                <div id="noti-inv" class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></div>
            </button>
             <button onclick="openModal('blacksmith')" class="flex flex-col items-center justify-center w-16 h-14 bg-gray-700 hover:bg-gray-600 rounded border border-gray-600 text-orange-400 text-[10px] font-bold uppercase">
                <i class="fa-solid fa-hammer text-xl mb-1"></i>Thợ Rèn
            </button>
        </div>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div id="modal-content" class="bg-gray-900 w-full max-w-2xl h-[85vh] border border-gray-600 rounded-lg flex flex-col shadow-2xl relative">
            </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const LOCAL_STORAGE_KEY = 'thien_dao_v1_5';
        const QUALITIES = ['Phàm', 'Khá', 'Tốt', 'Hiếm', 'Truyền Thuyết', 'Thần'];
        const QUALITY_COLORS = ['text-gray-400', 'text-green-400', 'text-blue-400', 'text-purple-400', 'text-yellow-400', 'text-red-500'];
        const STAT_NAMES = { 'attack': 'Công', 'hp': 'Máu', 'defense': 'Thủ', 'speed': 'Tốc', 'crit_rate': 'Bạo Kích', 'crit_dmg': 'ST Bạo', 'vamp': 'Hút Huyết' };
        
        const ITEMS_DB = {
            'stone_enhance': { name: 'Đá Cường Hóa', type: 'material', qual: 2, desc: 'Dùng để cường hóa trang bị' },
            'stone_refine': { name: 'Đá Tẩy Luyện', type: 'material', qual: 3, desc: 'Dùng để tẩy luyện thuộc tính' },
            'stone_star': { name: 'Đá Thăng Tinh', type: 'material', qual: 4, desc: 'Dùng để nâng sao trang bị' },
            'gem_atk': { name: 'Hồng Ngọc (Công)', type: 'gem', qual: 3, stat: 'attack', val: 50, desc: 'Khảm nạm tăng tấn công' },
            'gem_hp': { name: 'Hoàng Ngọc (Máu)', type: 'gem', qual: 3, stat: 'hp', val: 500, desc: 'Khảm nạm tăng sinh lực' }
        };

        const EQUIP_SLOTS = ['than_binh','huyen_quan','linh_giap','huyen_quan_leg','than_hai','nhan_trai','nhan_phai','ngoc_boi'];
        const EQUIP_NAMES = {
            'than_binh': ['Kiếm','Đao','Thương','Côn'], 'huyen_quan': ['Mũ','Nón','Khăn'], 
            'linh_giap': ['Áo','Giáp','Bào'], 'huyen_quan_leg': ['Quần','Khố'], 
            'than_hai': ['Giày','Ủng'], 'nhan_trai': ['Nhẫn Tả'], 'nhan_phai': ['Nhẫn Hữu'], 'ngoc_boi': ['Ngọc Bội']
        };

        // --- GAME STATE ---
        let gameData = {};
        let gameLoopInterval = null;
        let selectedItem = null; // For inventory/blacksmith interactions

        // --- CORE FUNCTIONS ---
        function getMaxExp(lv) { return lv >= 225 ? 42000000000 : Math.floor(100 * Math.pow(1.0933405, lv - 1)); }

        // --- ITEM GENERATOR ---
        function generateRandomDrop(level) {
            const rand = Math.random();
            // 20% ra Nguyên liệu, 80% ra Trang bị
            if (rand < 0.2) {
                const mats = Object.keys(ITEMS_DB);
                const matKey = mats[Math.floor(Math.random() * mats.length)];
                return { isEquip: false, id: matKey, count: 1, ...ITEMS_DB[matKey] };
            } else {
                // Random Quality based on weighted chance
                const qRand = Math.random();
                let q = 0; // Phàm
                if (qRand < 0.005) q = 5; // Thần (0.5%)
                else if (qRand < 0.02) q = 4; // Truyền Thuyết (1.5%)
                else if (qRand < 0.1) q = 3; // Hiếm
                else if (qRand < 0.3) q = 2; // Tốt
                else if (qRand < 0.6) q = 1; // Khá

                // Random Slot
                const slot = EQUIP_SLOTS[Math.floor(Math.random() * EQUIP_SLOTS.length)];
                const baseName = EQUIP_NAMES[slot][Math.floor(Math.random() * EQUIP_NAMES[slot].length)];
                
                // Base Stats Scaling
                const mult = (level * 2) * (1 + q * 0.5);
                let mainStat = {};
                if (['than_binh','nhan_trai','nhan_phai'].includes(slot)) mainStat = { attack: Math.floor(mult * 5) };
                else if (['linh_giap','huyen_quan_leg'].includes(slot)) mainStat = { hp: Math.floor(mult * 50) };
                else mainStat = { defense: Math.floor(mult * 2) };

                // Random Options
                const opts = [];
                const optCount = Math.floor(Math.random() * (q + 1)) + 1; // 1 to 6 lines
                const optPool = ['attack','hp','defense','speed','crit_rate','crit_dmg','vamp'];
                for(let i=0; i<optCount; i++) {
                    const s = optPool[Math.floor(Math.random() * optPool.length)];
                    let val = 0;
                    if(s.includes('rate') || s.includes('vamp')) val = parseFloat((Math.random() * (q+1)).toFixed(2)); // % small
                    else if (s.includes('dmg')) val = Math.floor(Math.random() * 10 * (q+1));
                    else val = Math.floor(level * (q+1) + Math.random()*10);
                    opts.push({ stat: s, val: val });
                }

                return {
                    id: Date.now() + Math.random().toString(),
                    isEquip: true,
                    type: slot,
                    name: `${QUALITIES[q]} ${baseName}`,
                    quality: q,
                    level: level,
                    enhanceLv: 0,
                    starLv: 0,
                    sockets: [null, null, null], // 3 slots max
                    baseStats: mainStat,
                    options: opts
                };
            }
        }

        // --- GAME LOOP ---
        function startGameLoop() {
            if (gameLoopInterval) clearInterval(gameLoopInterval);
            gameLoopInterval = setInterval(gameTick, 1000);
        }

        function gameTick() {
            const now = Date.now();
            // AFK limit 24h
            const elapsed = Math.min(now - gameData.lastTick, 86400000); 
            const multiplier = elapsed / 1000;
            gameData.lastTick = now;

            const p = gameData.player;
            // 1. Resources
            const stoneGain = Math.floor((Math.floor(p.level/3)+1) * multiplier);
            gameData.resources.spirit_stones += stoneGain;

            // 2. EXP
            const maxExp = getMaxExp(p.level);
            let expGain = Math.floor((maxExp / 450) * multiplier);
            if(expGain < 1) expGain = 1;
            p.exp += expGain;

            // 3. Drop System (Chance per tick)
            // Base chance 5% per second to find something
            if (Math.random() < 0.05 * multiplier) {
                const item = generateRandomDrop(p.level);
                addItemToInventory(item);
                showToast(`Bạn nhận được: <span class="${item.isEquip ? 'q-'+item.quality : 'text-white'}">${item.name}</span>`);
            }

            // Level Up
            while (p.exp >= maxExp && p.level < 225) {
                p.exp -= maxExp;
                p.level++;
                p.potentialPoints += 10;
                showToast(`Đột phá! Cảnh giới hiện tại: ${getRealmName(p.level)}`, 'gold');
            }

            saveToLocalStorage();
            updateUI();
        }

        function addItemToInventory(item) {
            if (item.isEquip) {
                gameData.inventory.equips.push(item);
            } else {
                // Stack items
                const exist = gameData.inventory.items.find(i => i.id === item.id);
                if (exist) exist.count += item.count;
                else gameData.inventory.items.push(item);
            }
            // Noti dot logic could go here
        }

        // --- UI RENDERERS ---
        function showToast(msg, type='normal') {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            div.className = 'toast border-l-4 ' + (type==='gold' ? 'border-yellow-500' : 'border-blue-500');
            div.innerHTML = msg;
            container.appendChild(div);
            setTimeout(() => {
                div.style.opacity = '0';
                div.style.transform = 'translateX(100%)';
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }

        function openModal(type) {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.classList.remove('hidden');
            
            let html = '';
            if (type === 'character') {
                html = renderCharacterModal();
            } else if (type === 'inventory') {
                html = renderInventoryModal();
            } else if (type === 'blacksmith') {
                html = renderBlacksmithModal();
            }

            content.innerHTML = html;
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
            selectedItem = null;
        }

        // --- INVENTORY UI ---
        function renderInventoryModal() {
            return `
            <div class="flex justify-between items-center p-3 border-b border-gray-700 bg-gray-800">
                <h3 class="text-blue-400 font-bold"><i class="fa-solid fa-sack-dollar mr-2"></i>Túi Đồ</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="flex border-b border-gray-700 bg-gray-800/50">
                <button onclick="switchInvTab('equips')" id="inv-tab-equips" class="flex-1 py-2 text-sm font-bold border-b-2 border-blue-500 text-blue-500">Trang Bị (${gameData.inventory.equips.length})</button>
                <button onclick="switchInvTab('items')" id="inv-tab-items" class="flex-1 py-2 text-sm font-bold text-gray-400 hover:text-gray-200">Vật Phẩm</button>
            </div>
            <div id="inv-content" class="flex-1 overflow-y-auto p-2 custom-scroll grid grid-cols-4 gap-2 content-start">
                ${renderInvEquips()}
            </div>
            <div id="inv-actions" class="p-3 bg-gray-800 border-t border-gray-700 h-32 text-xs text-gray-400">
                Chọn một vật phẩm để xem chi tiết
            </div>
            `;
        }

        function switchInvTab(tab) {
            const content = document.getElementById('inv-content');
            const btnEq = document.getElementById('inv-tab-equips');
            const btnIt = document.getElementById('inv-tab-items');
            
            if(tab === 'equips') {
                btnEq.className = "flex-1 py-2 text-sm font-bold border-b-2 border-blue-500 text-blue-500";
                btnIt.className = "flex-1 py-2 text-sm font-bold text-gray-400";
                content.innerHTML = renderInvEquips();
            } else {
                btnIt.className = "flex-1 py-2 text-sm font-bold border-b-2 border-blue-500 text-blue-500";
                btnEq.className = "flex-1 py-2 text-sm font-bold text-gray-400";
                content.innerHTML = renderInvItems();
            }
            document.getElementById('inv-actions').innerHTML = 'Chọn một vật phẩm để xem chi tiết';
        }

        function renderInvEquips() {
            return gameData.inventory.equips.map((item, idx) => `
                <div onclick="selectInvItem(${idx}, true)" class="aspect-square bg-gray-900 border border-gray-700 rounded hover:border-blue-500 cursor-pointer flex flex-col items-center justify-center p-1 relative">
                    <i class="fa-solid fa-shield-halved text-2xl q-${item.quality}"></i>
                    <div class="text-[9px] text-center mt-1 truncate w-full q-${item.quality}">${item.name}</div>
                    <div class="absolute top-0 right-0 bg-gray-800 text-[8px] px-1 rounded">Lv.${item.level}</div>
                    ${item.enhanceLv > 0 ? `<div class="absolute bottom-0 right-0 text-yellow-500 text-[9px]">+${item.enhanceLv}</div>` : ''}
                </div>
            `).join('');
        }

        function renderInvItems() {
            return gameData.inventory.items.map((item, idx) => `
                <div onclick="selectInvItem(${idx}, false)" class="aspect-square bg-gray-900 border border-gray-700 rounded hover:border-blue-500 cursor-pointer flex flex-col items-center justify-center p-1 relative">
                    <i class="fa-solid ${item.type==='gem'?'fa-gem':'fa-cubes'} text-2xl text-gray-300"></i>
                    <div class="text-[9px] text-center mt-1 truncate w-full text-white">${item.name}</div>
                    <div class="absolute bottom-1 right-1 bg-gray-700 text-[9px] px-1 rounded">x${item.count}</div>
                </div>
            `).join('');
        }

        function selectInvItem(idx, isEquip) {
            const item = isEquip ? gameData.inventory.equips[idx] : gameData.inventory.items[idx];
            selectedItem = { ...item, index: idx, isInventory: true }; // Store ref
            
            const detailPanel = document.getElementById('inv-actions');
            if (isEquip) {
                // Render stats
                let statsHtml = Object.entries(item.baseStats).map(([k,v]) => `<div>${STAT_NAMES[k]||k}: +${v}</div>`).join('');
                item.options.forEach(o => statsHtml += `<div class="text-blue-300">${STAT_NAMES[o.stat]||o.stat}: +${o.val}${o.stat.includes('rate')||o.stat.includes('vamp')?'%':''}</div>`);
                
                detailPanel.innerHTML = `
                    <div class="flex gap-3 h-full">
                        <div class="w-1/3 flex items-center justify-center bg-gray-900 rounded border border-gray-600">
                            <i class="fa-solid fa-shield-halved text-4xl q-${item.quality}"></i>
                        </div>
                        <div class="flex-1 overflow-y-auto">
                            <div class="font-bold q-${item.quality}">${item.name} (+${item.enhanceLv})</div>
                            <div class="text-[10px] text-yellow-500">Sao: ${'★'.repeat(item.starLv)}</div>
                            <div class="text-xs mt-1 space-y-0.5">${statsHtml}</div>
                        </div>
                        <div class="flex flex-col justify-center gap-2">
                             <button onclick="equipItem(${idx})" class="px-3 py-1 bg-green-700 hover:bg-green-600 text-white rounded text-xs font-bold">Trang Bị</button>
                             <button onclick="sellItem(${idx}, true)" class="px-3 py-1 bg-red-900 hover:bg-red-800 text-white rounded text-xs">Bán</button>
                        </div>
                    </div>
                `;
            } else {
                detailPanel.innerHTML = `
                    <div class="flex gap-3 h-full items-center">
                        <div class="w-16 h-16 flex items-center justify-center bg-gray-900 rounded border border-gray-600">
                            <i class="fa-solid ${item.type==='gem'?'fa-gem':'fa-cubes'} text-3xl text-white"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-white">${item.name}</div>
                            <div class="text-xs text-gray-400 italic">${item.desc}</div>
                            <div class="text-xs mt-1">Số lượng: ${item.count}</div>
                        </div>
                    </div>
                `;
            }
        }

        function equipItem(idx) {
            const item = gameData.inventory.equips[idx];
            const slot = item.type;
            
            // Swap logic
            const currentEquip = gameData.player.equipped[slot];
            gameData.player.equipped[slot] = item;
            
            gameData.inventory.equips.splice(idx, 1); // Remove from inv
            if (currentEquip) gameData.inventory.equips.push(currentEquip); // Add old back to inv
            
            saveToLocalStorage();
            updateUI();
            openModal('inventory'); // Re-render
            showToast("Đã trang bị!");
        }

        // --- BLACKSMITH UI ---
        function renderBlacksmithModal() {
            // Filter equips only
            const equips = gameData.inventory.equips;
            const equipped = Object.values(gameData.player.equipped).filter(x => x);
            const allEquips = [...equipped, ...equips];

            return `
            <div class="flex justify-between items-center p-3 border-b border-gray-700 bg-gray-800">
                <h3 class="text-orange-400 font-bold"><i class="fa-solid fa-hammer mr-2"></i>Thợ Rèn</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="flex h-full overflow-hidden">
                <div class="w-1/3 bg-gray-800/30 border-r border-gray-700 overflow-y-auto custom-scroll p-2 space-y-2">
                    <div class="text-xs text-gray-500 font-bold uppercase mb-2">Đang mặc</div>
                    ${equipped.map(i => renderSmallItem(i, 'equipped')).join('')}
                    <div class="text-xs text-gray-500 font-bold uppercase mt-4 mb-2">Trong túi</div>
                    ${equips.map((i, idx) => renderSmallItem(i, idx)).join('')}
                </div>

                <div class="flex-1 flex flex-col">
                    <div class="flex border-b border-gray-700 bg-gray-800/50">
                        <button onclick="switchBsTab('enhance')" id="bs-tab-enhance" class="flex-1 py-2 text-xs font-bold border-b-2 border-orange-500 text-orange-500">Cường Hóa</button>
                        <button onclick="switchBsTab('refine')" id="bs-tab-refine" class="flex-1 py-2 text-xs font-bold text-gray-400">Tẩy Luyện</button>
                        <button onclick="switchBsTab('socket')" id="bs-tab-socket" class="flex-1 py-2 text-xs font-bold text-gray-400">Khảm Ngọc</button>
                        <button onclick="switchBsTab('star')" id="bs-tab-star" class="flex-1 py-2 text-xs font-bold text-gray-400">Thăng Tinh</button>
                    </div>
                    
                    <div id="bs-content" class="flex-1 p-4 flex flex-col items-center justify-center relative">
                        <div class="text-gray-500 text-sm">Chọn một trang bị bên trái để bắt đầu</div>
                    </div>
                </div>
            </div>
            `;
        }

        function renderSmallItem(item, idRef) {
            const isWearing = typeof idRef === 'string';
            const clickFn = isWearing 
                ? `selectBsItem('equipped', '${item.type}')` 
                : `selectBsItem('inventory', ${idRef})`;
            
            return `
            <div onclick="${clickFn}" class="flex items-center gap-2 p-2 bg-gray-900 border border-gray-700 rounded cursor-pointer hover:border-orange-500">
                <i class="fa-solid fa-shield-halved q-${item.quality}"></i>
                <div class="flex-1 min-w-0">
                    <div class="text-xs truncate q-${item.quality}">${item.name}</div>
                    <div class="text-[9px] text-gray-500">+${item.enhanceLv} | ${'★'.repeat(item.starLv)}</div>
                </div>
            </div>`;
        }

        let currentBsTab = 'enhance';
        function switchBsTab(tab) {
            currentBsTab = tab;
            ['enhance','refine','socket','star'].forEach(t => {
                document.getElementById(`bs-tab-${t}`).className = `flex-1 py-2 text-xs font-bold ${t===tab ? 'border-b-2 border-orange-500 text-orange-500' : 'text-gray-400'}`;
            });
            renderBsActionPanel();
        }

        function selectBsItem(source, id) {
            if (source === 'equipped') {
                selectedItem = gameData.player.equipped[id];
            } else {
                selectedItem = gameData.inventory.equips[id];
            }
            renderBsActionPanel();
        }

        function renderBsActionPanel() {
            const container = document.getElementById('bs-content');
            if (!selectedItem) return;
            
            const item = selectedItem;
            // Common Info
            let html = `
                <div class="mb-4 text-center">
                    <div class="text-lg font-bold q-${item.quality}">${item.name}</div>
                    <div class="text-xs text-gray-400">Cấp cường hóa: +${item.enhanceLv}</div>
                </div>
            `;

            const p = gameData.player;
            const stones = gameData.resources.spirit_stones;

            if (currentBsTab === 'enhance') {
                const costStone = (item.enhanceLv + 1) * 100 * (item.quality + 1);
                const matReq = (item.enhanceLv + 1);
                const hasMat = countItem('stone_enhance');
                const successRate = Math.max(10, 100 - (item.enhanceLv * 5));

                html += `
                    <div class="text-center space-y-4">
                        <div class="text-sm">Tăng chỉ số cơ bản thêm 10% mỗi cấp</div>
                        <div class="text-green-400">Tỉ lệ thành công: ${successRate}%</div>
                        <div class="bg-gray-800 p-3 rounded text-xs space-y-1">
                            <div class="${stones >= costStone ? 'text-white':'text-red-500'}">Linh Thạch: ${stones}/${costStone}</div>
                            <div class="${hasMat >= matReq ? 'text-white':'text-red-500'}">Đá Cường Hóa: ${hasMat}/${matReq}</div>
                        </div>
                        <button onclick="doEnhance()" class="px-6 py-2 bg-orange-700 hover:bg-orange-600 rounded text-white font-bold">Cường Hóa</button>
                    </div>
                `;
            } else if (currentBsTab === 'refine') {
                 const costStone = 500 * (item.quality + 1);
                 const hasMat = countItem('stone_refine');
                 html += `
                    <div class="text-center space-y-4">
                        <div class="text-sm">Random lại các dòng thuộc tính phụ</div>
                        <div class="bg-gray-800 p-3 rounded text-xs text-left max-h-32 overflow-y-auto">
                            ${item.options.map(o => `<div>${STAT_NAMES[o.stat]||o.stat}: ${o.val}</div>`).join('')}
                        </div>
                        <div class="bg-gray-800 p-3 rounded text-xs space-y-1">
                            <div class="${stones >= costStone ? 'text-white':'text-red-500'}">Linh Thạch: ${stones}/${costStone}</div>
                            <div class="${hasMat >= 1 ? 'text-white':'text-red-500'}">Đá Tẩy Luyện: ${hasMat}/1</div>
                        </div>
                        <button onclick="doRefine()" class="px-6 py-2 bg-purple-700 hover:bg-purple-600 rounded text-white font-bold">Tẩy Luyện</button>
                    </div>
                `;
            } else if (currentBsTab === 'socket') {
                html += `<div class="w-full space-y-2">`;
                item.sockets.forEach((gemId, idx) => {
                    html += `
                    <div class="flex justify-between items-center bg-gray-800 p-2 rounded border border-gray-600">
                        <div class="text-xs">${gemId ? ITEMS_DB[gemId].name : 'Khe trống'}</div>
                        ${gemId 
                            ? `<button onclick="doUnsocket(${idx})" class="text-[10px] bg-red-900 px-2 py-1 rounded">Gỡ (500 Đá)</button>`
                            : `<button onclick="renderGemSelect(${idx})" class="text-[10px] bg-green-700 px-2 py-1 rounded">Khảm</button>`
                        }
                    </div>`;
                });
                html += `</div><div id="gem-list" class="mt-2 w-full max-h-32 overflow-y-auto hidden bg-gray-900 border border-gray-600 p-2"></div>`;
            } else if (currentBsTab === 'star') {
                 const costStone = (item.starLv + 1) * 1000 * (item.quality + 1);
                 const hasMat = countItem('stone_star');
                 const matReq = (item.starLv + 1);
                 html += `
                    <div class="text-center space-y-4">
                        <div class="text-sm">Thăng tinh tăng mạnh toàn bộ chỉ số</div>
                        <div class="text-yellow-400 font-bold text-2xl">${'★'.repeat(item.starLv)} <span class="text-gray-600">-></span> ${'★'.repeat(item.starLv+1)}</div>
                        <div class="bg-gray-800 p-3 rounded text-xs space-y-1">
                            <div class="${stones >= costStone ? 'text-white':'text-red-500'}">Linh Thạch: ${stones}/${costStone}</div>
                            <div class="${hasMat >= matReq ? 'text-white':'text-red-500'}">Đá Thăng Tinh: ${hasMat}/${matReq}</div>
                        </div>
                        <button onclick="doStarUp()" class="px-6 py-2 bg-yellow-700 hover:bg-yellow-600 rounded text-white font-bold">Thăng Tinh</button>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // --- BLACKSMITH ACTIONS ---
        function countItem(id) {
            const it = gameData.inventory.items.find(i => i.id === id);
            return it ? it.count : 0;
        }
        function consumeItem(id, amt) {
            const it = gameData.inventory.items.find(i => i.id === id);
            if(it && it.count >= amt) {
                it.count -= amt;
                if(it.count <= 0) gameData.inventory.items = gameData.inventory.items.filter(i => i.id !== id);
                return true;
            }
            return false;
        }

        function doEnhance() {
            if(!selectedItem) return;
            const item = selectedItem;
            const cost = (item.enhanceLv + 1) * 100 * (item.quality + 1);
            const matReq = item.enhanceLv + 1;
            
            if(gameData.resources.spirit_stones >= cost && consumeItem('stone_enhance', matReq)) {
                gameData.resources.spirit_stones -= cost;
                const rate = Math.max(10, 100 - (item.enhanceLv * 5));
                if(Math.random() * 100 < rate) {
                    item.enhanceLv++;
                    showToast("Cường hóa thành công!", 'gold');
                } else {
                    showToast("Cường hóa thất bại!", 'normal');
                }
                saveToLocalStorage();
                renderBsActionPanel();
            } else {
                showToast("Không đủ nguyên liệu!");
            }
        }

        function doRefine() {
            if(!selectedItem) return;
            const item = selectedItem;
            const cost = 500 * (item.quality + 1);
            
            if(gameData.resources.spirit_stones >= cost && consumeItem('stone_refine', 1)) {
                gameData.resources.spirit_stones -= cost;
                // Reroll Options logic (simplified from generateRandomDrop)
                const optCount = item.options.length;
                const newOpts = [];
                const optPool = ['attack','hp','defense','speed','crit_rate','crit_dmg','vamp'];
                for(let i=0; i<optCount; i++) {
                    const s = optPool[Math.floor(Math.random() * optPool.length)];
                    let val = 0;
                    if(s.includes('rate') || s.includes('vamp')) val = parseFloat((Math.random() * (item.quality+1)).toFixed(2));
                    else if (s.includes('dmg')) val = Math.floor(Math.random() * 10 * (item.quality+1));
                    else val = Math.floor(item.level * (item.quality+1) + Math.random()*10);
                    newOpts.push({ stat: s, val: val });
                }
                item.options = newOpts;
                showToast("Tẩy luyện thành công!", 'gold');
                saveToLocalStorage();
                renderBsActionPanel();
            } else {
                showToast("Không đủ nguyên liệu!");
            }
        }

        function doStarUp() {
            if(!selectedItem) return;
            const item = selectedItem;
            const cost = (item.starLv + 1) * 1000 * (item.quality + 1);
            const matReq = item.starLv + 1;
            
            if(gameData.resources.spirit_stones >= cost && consumeItem('stone_star', matReq)) {
                gameData.resources.spirit_stones -= cost;
                item.starLv++;
                showToast("Thăng tinh thành công!", 'gold');
                saveToLocalStorage();
                renderBsActionPanel();
            } else {
                showToast("Không đủ nguyên liệu!");
            }
        }

        function renderGemSelect(slotIdx) {
            const list = document.getElementById('gem-list');
            list.classList.remove('hidden');
            const gems = gameData.inventory.items.filter(i => i.type === 'gem');
            if(gems.length === 0) {
                list.innerHTML = '<div class="text-xs text-gray-500">Không có ngọc trong túi</div>';
                return;
            }
            list.innerHTML = gems.map(g => `
                <div onclick="doSocket(${slotIdx}, '${g.id}')" class="flex justify-between items-center p-1 hover:bg-gray-800 cursor-pointer border-b border-gray-700">
                    <span class="text-xs text-white">${g.name}</span>
                    <span class="text-[10px] text-gray-400">x${g.count}</span>
                </div>
            `).join('');
        }

        function doSocket(slotIdx, gemId) {
            if(!selectedItem) return;
            if(consumeItem(gemId, 1)) {
                selectedItem.sockets[slotIdx] = gemId;
                showToast("Khảm ngọc thành công!");
                saveToLocalStorage();
                renderBsActionPanel();
            }
        }

        function doUnsocket(slotIdx) {
            if(!selectedItem) return;
            const gemId = selectedItem.sockets[slotIdx];
            if(gameData.resources.spirit_stones >= 500) {
                gameData.resources.spirit_stones -= 500;
                selectedItem.sockets[slotIdx] = null;
                addItemToInventory({ isEquip: false, id: gemId, count: 1, ...ITEMS_DB[gemId] }); // Return gem
                showToast("Gỡ ngọc thành công!");
                saveToLocalStorage();
                renderBsActionPanel();
            } else {
                showToast("Cần 500 Linh Thạch để gỡ!");
            }
        }

        // --- STAT CALCULATION (UPDATED) ---
        function calculateStats() {
            const p = gameData.player;
            // Simplified Stats from previous version
            let stats = { attack: 10, hp: 100, defense: 5, speed: 10, crit_rate: 0 };
            
            // 1. Equipments Stats
            Object.values(p.equipped).forEach(item => {
                if(!item) return;
                // Enhance Multiplier
                const enhanceMult = 1 + (item.enhanceLv * 0.1);
                // Star Multiplier
                const starMult = 1 + (item.starLv * 0.2);
                
                // Base
                Object.entries(item.baseStats).forEach(([k,v]) => {
                    if(!stats[k]) stats[k] = 0;
                    stats[k] += Math.floor(v * enhanceMult * starMult);
                });
                
                // Options
                item.options.forEach(opt => {
                    if(!stats[opt.stat]) stats[opt.stat] = 0;
                    stats[opt.stat] += opt.val;
                });

                // Gems
                item.sockets.forEach(gemId => {
                    if(gemId) {
                        const g = ITEMS_DB[gemId];
                        if(!stats[g.stat]) stats[g.stat] = 0;
                        stats[g.stat] += g.val;
                    }
                });
            });

            // 2. Attributes (Simplified from previous)
            stats.attack += (p.attributes?.strength || 0) * 5;
            stats.hp += (p.attributes?.body || 0) * 50;

            return stats;
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            if(localStorage.getItem(LOCAL_STORAGE_KEY)) {
                document.getElementById('btn-continue').classList.remove('hidden');
            }
        };

        function newGame() {
            if(localStorage.getItem(LOCAL_STORAGE_KEY) && !confirm("Xóa dữ liệu cũ?")) return;
            gameData = {
                player: {
                    name: 'Vô Danh', level: 1, exp: 0,
                    equipped: { than_binh:null, huyen_quan:null, linh_giap:null, huyen_quan_leg:null, than_hai:null, nhan_trai:null, nhan_phai:null, ngoc_boi:null },
                    attributes: { body:0, strength:0, bone:0, agility:0 },
                    potentialPoints: 0
                },
                resources: { spirit_stones: 0 },
                inventory: { equips: [], items: [] },
                lastTick: Date.now()
            };
            // Give starter items
            addItemToInventory(generateRandomDrop(1));
            addItemToInventory({ isEquip: false, id: 'stone_enhance', count: 10, ...ITEMS_DB['stone_enhance'] });
            
            saveToLocalStorage();
            enterGame();
        }

        function continueGame() {
            const saved = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY));
            // Merge logic to avoid crash on update
            if(!saved.inventory) saved.inventory = { equips: [], items: [] };
            if(!saved.player.equipped) saved.player.equipped = {};
            gameData = saved;
            enterGame();
        }

        function enterGame() {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            updateUI();
            startGameLoop();
        }

        function returnToMenu() {
            clearInterval(gameLoopInterval);
            saveToLocalStorage();
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
        }

        function saveToLocalStorage() { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(gameData)); }

        function updateUI() {
            const p = gameData.player;
            document.getElementById('display-name').innerText = p.name;
            document.getElementById('display-stones').innerText = p.resources?.spirit_stones || gameData.resources.spirit_stones;
            document.getElementById('display-realm').innerText = getRealmName(p.level);
            
            // Noti Dots
            document.getElementById('noti-inv').className = gameData.inventory.equips.length > 0 ? "absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full" : "hidden";
        }
        
        // Helpers
        function getRealmName(lv) { return lv < 10 ? `Luyện Khí ${lv}` : `Trúc Cơ ${lv-9}`; } // Simplified
        function triggerFileInput() { document.getElementById('file-upload').click(); }
        function handleFileUpload(input) { const f = input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ gameData=JSON.parse(e.target.result); saveToLocalStorage(); enterGame(); }; r.readAsText(f); }
        function exportSaveFile() { const b = new Blob([JSON.stringify(gameData)], {type:"application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'save.json'; a.click(); }
        
        // Character Modal (Simplified for size)
        function renderCharacterModal() {
            const stats = calculateStats();
            return `
            <div class="p-4 text-white">
                <h3 class="font-bold text-yellow-500 mb-4">Chỉ Số Nhân Vật</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    ${Object.entries(stats).map(([k,v]) => `<div>${STAT_NAMES[k]||k}: ${v}</div>`).join('')}
                </div>
                <div class="mt-4 text-xs text-gray-400">Trang bị đang mặc hiển thị trong tab Thợ Rèn</div>
                <button onclick="closeModal()" class="mt-4 w-full bg-gray-700 py-2 rounded">Đóng</button>
            </div>`;
        }
    </script>
</body>
</html>