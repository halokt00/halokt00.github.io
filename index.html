<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thiên Đạo Tu Tiên - Webgame Text RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #0f172a; color: #e2e8f0;
            background-image: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
        }
        .game-title { font-family: 'Cinzel', serif; text-shadow: 0 0 10px rgba(234, 179, 8, 0.5); }
        .meditating-img { animation: breathe 4s ease-in-out infinite; }
        @keyframes breathe { 0%, 100% { opacity: 0.9; transform: scale(1); } 50% { opacity: 1; transform: scale(1.02); box-shadow: 0 0 30px rgba(234, 179, 8, 0.4); } }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }

        /* Quality Colors */
        .q-0 { color: #9ca3af; } /* Phàm */
        .q-1 { color: #4ade80; } /* Khá */
        .q-2 { color: #60a5fa; } /* Tốt */
        .q-3 { color: #c084fc; } /* Hiếm */
        .q-4 { color: #facc15; } /* Truyền Thuyết */
        .q-5 { color: #ef4444; text-shadow: 0 0 5px red; } /* Thần */

        /* Toast & Combat Log */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: rgba(15, 23, 42, 0.95); border: 1px solid #475569; padding: 12px 20px; border-radius: 8px; color: white; animation: slideIn 0.3s ease-out; pointer-events: auto; max-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); font-size: 13px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .combat-log p { margin-bottom: 4px; border-bottom: 1px solid #334155; padding-bottom: 2px; }
        .log-player { color: #4ade80; }
        .log-enemy { color: #f87171; }
        .log-info { color: #fbbf24; font-weight: bold; }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <input type="file" id="file-upload" class="hidden" accept=".json" onchange="handleFileUpload(this)">
    <div id="toast-container"></div>

    <div id="main-menu" class="w-full max-w-md text-center space-y-8">
        <div class="space-y-2">
            <i class="fa-solid fa-yin-yang text-6xl text-yellow-500 animate-spin" style="animation-duration: 10s;"></i>
            <h1 class="text-4xl md:text-5xl font-bold text-yellow-500 game-title tracking-wider mt-4">THIÊN ĐẠO <br> <span class="text-white text-2xl md:text-3xl">TU TIÊN</span></h1>
        </div>
        <div class="flex flex-col gap-4 px-8">
            <button id="btn-continue" onclick="continueGame()" class="hidden py-3 bg-green-900 border border-green-700 text-green-100 rounded font-bold">Tiếp Tục</button>
            <button onclick="newGame()" class="py-3 bg-gray-800 border border-gray-600 hover:bg-gray-700 text-gray-200 rounded font-bold">Chơi Mới</button>
            <button onclick="triggerFileInput()" class="py-3 bg-blue-900 border border-blue-700 hover:bg-blue-800 text-blue-100 rounded font-bold">Tải Save</button>
        </div>
        <div class="text-xs text-gray-600 mt-8">Ver 1.6.0 - Tháp Vô Tận & Ngọc</div>
    </div>

    <div id="modal-selection" class="hidden fixed inset-0 bg-black z-[100] flex items-center justify-center p-4">
        <div class="bg-gray-900 w-full max-w-4xl h-[90vh] border border-yellow-600 rounded-lg flex flex-col shadow-2xl relative">
            <div class="bg-gray-800 p-4 text-center"><h2 class="text-xl font-bold text-yellow-500">KHỞI ĐẦU ĐẠO LỘ</h2></div>
            <div class="flex-1 overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 gap-4 custom-scroll">
                <div><h3 class="font-bold text-white mb-2">Chọn Đạo</h3><div id="dao-list" class="space-y-2"></div></div>
                <div><h3 class="font-bold text-white mb-2">Chọn Căn</h3><div id="root-list" class="space-y-2"></div></div>
            </div>
            <div class="p-4 bg-gray-800 flex justify-between items-center">
                <div class="text-xs text-gray-400">Đạo: <span id="sel-dao-txt" class="text-white">---</span> | Căn: <span id="sel-root-txt" class="text-white">---</span></div>
                <button onclick="confirmSelection()" id="btn-sel-confirm" class="px-6 py-2 bg-gray-700 text-gray-400 font-bold rounded cursor-not-allowed" disabled>BẮT ĐẦU</button>
            </div>
        </div>
    </div>

    <div id="game-container" class="hidden w-full max-w-4xl h-[90vh] bg-gray-900 border border-gray-700 rounded-xl shadow-2xl relative overflow-hidden flex flex-col">
        <div class="bg-gray-800 p-2 border-b border-gray-700 flex justify-between items-center shadow-md z-10 text-xs md:text-sm">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-gray-700 border border-yellow-600 flex items-center justify-center text-yellow-500"><i class="fa-solid fa-user-ninja"></i></div>
                <div>
                    <div id="display-name" class="font-bold text-yellow-500">Vô Danh</div>
                    <div id="display-realm" class="text-cyan-300">Phàm Nhân</div>
                </div>
            </div>
             <div class="flex gap-4">
                <div class="text-blue-400" title="Linh Thạch"><i class="fa-solid fa-gem mr-1"></i><span id="display-stones">0</span></div>
                <div class="text-purple-400" title="Điểm Tháp"><i class="fa-solid fa-dungeon mr-1"></i><span id="display-tower-pts">0</span></div>
            </div>
            <div class="flex gap-1">
                <button onclick="exportSaveFile()" class="bg-green-800 text-white px-2 py-1 rounded">Lưu</button>
                <button onclick="returnToMenu()" class="bg-red-900 text-white px-2 py-1 rounded">Thoát</button>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] flex flex-col items-center justify-center">
            <div class="max-w-md w-full text-center space-y-6 relative z-10">
                <div class="relative w-48 h-48 mx-auto rounded-full border-4 border-yellow-600/50 overflow-hidden shadow-[0_0_30px_rgba(234,179,8,0.2)] bg-black">
                    <img src="https://i.pinimg.com/564x/c1/8d/19/c18d19606a928b9d4b0a7341b833c26d.jpg" class="w-full h-full object-cover meditating-img">
                </div>
                <div>
                    <h2 class="text-lg font-bold text-yellow-100">Đang Nhập Định Tu Hành...</h2>
                    <p class="text-xs text-cyan-400 animate-pulse mt-1">Tự động hấp thu linh khí & Tìm kiếm cơ duyên</p>
                    <p id="gain-rate-text" class="text-[10px] text-gray-500 mt-2"></p>
                </div>
                <div class="bg-gray-800 rounded-full h-5 w-full border border-gray-600 relative overflow-hidden shadow">
                    <div id="exp-bar" class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 transition-all duration-500" style="width: 0%"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white"><span id="exp-text">0 / 100</span></div>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 p-2 border-t border-gray-700 flex justify-center gap-2 z-20">
            <button onclick="openModal('character')" class="w-14 h-12 bg-gray-700 hover:bg-gray-600 rounded border border-gray-600 text-yellow-500 text-[9px] font-bold uppercase flex flex-col items-center justify-center relative">
                <i class="fa-solid fa-user-shield text-lg mb-1"></i>Nhân Vật
                <div id="noti-char" class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></div>
            </button>
            <button onclick="openModal('inventory')" class="w-14 h-12 bg-gray-700 hover:bg-gray-600 rounded border border-gray-600 text-blue-400 text-[9px] font-bold uppercase flex flex-col items-center justify-center relative">
                <i class="fa-solid fa-sack-dollar text-lg mb-1"></i>Túi Đồ
                <div id="noti-inv" class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></div>
            </button>
             <button onclick="openModal('blacksmith')" class="w-14 h-12 bg-gray-700 hover:bg-gray-600 rounded border border-gray-600 text-orange-400 text-[9px] font-bold uppercase flex flex-col items-center justify-center">
                <i class="fa-solid fa-hammer text-lg mb-1"></i>Thợ Rèn
            </button>
            <button onclick="openModal('tower')" class="w-14 h-12 bg-gray-700 hover:bg-gray-600 rounded border border-gray-600 text-purple-500 text-[9px] font-bold uppercase flex flex-col items-center justify-center">
                <i class="fa-solid fa-dungeon text-lg mb-1"></i>Tháp
            </button>
        </div>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-2 md:p-4">
        <div id="modal-content" class="bg-gray-900 w-full max-w-3xl h-[85vh] border border-gray-600 rounded-lg flex flex-col shadow-2xl relative overflow-hidden">
            </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const LOCAL_STORAGE_KEY = 'thien_dao_v1_6';
        const DAO_PATHS = {
            'kiem_tu': { name: 'Kiếm Tu', desc: 'Sát thương cực đại', bonus: 'attack_percent' },
            'the_tu': { name: 'Thể Tu', desc: 'Máu trâu phản đòn', bonus: 'hp_percent' },
            'ma_tu': { name: 'Ma Tu', desc: 'Bán máu lấy công', bonus: 'vamp' },
            'than_tinh': { name: 'Thần Tinh', desc: 'Chí mạng né tránh', bonus: 'crit_rate' },
            'van_thanh': { name: 'Văn Thánh', desc: 'Toàn diện hỗ trợ', bonus: 'dmg_reduce' },
            'dao_mon': { name: 'Đạo Môn', desc: 'Thủ cao khiên dày', bonus: 'defense_percent' }
        };
        const SPIRIT_ROOTS = {
            'kim': { name: 'Kim', color: 'text-yellow-400' }, 'moc': { name: 'Mộc', color: 'text-green-400' },
            'thuy': { name: 'Thủy', color: 'text-blue-400' }, 'hoa': { name: 'Hỏa', color: 'text-red-400' },
            'tho': { name: 'Thổ', color: 'text-gray-400' }
        };
        const GEM_TYPES = [
            { id: 'gem_atk', name: 'Hồng Ngọc', stat: 'attack', val: 50, desc: 'Công' },
            { id: 'gem_hp', name: 'Hoàng Ngọc', stat: 'hp', val: 500, desc: 'Máu' },
            { id: 'gem_def', name: 'Lam Ngọc', stat: 'defense', val: 25, desc: 'Thủ' },
            { id: 'gem_crit', name: 'Tử Ngọc', stat: 'crit_rate', val: 0.5, desc: 'Bạo%', isPct: true },
            { id: 'gem_speed', name: 'Thanh Ngọc', stat: 'speed', val: 10, desc: 'Tốc' }
        ];

        let gameData = {};
        let tempSel = { dao: null, root: null };
        let gameLoopInt = null;
        let selectedItem = null;

        // --- CORE FUNCTIONS ---
        function getMaxExp(lv) { return lv >= 225 ? 42000000000 : Math.floor(100 * Math.pow(1.0933405, lv - 1)); }
        
        function calculateStats(entity = 'player', enemyFloor = 0) {
            if (entity === 'enemy') {
                // Enemy Scaling: Floor 1 -> 3000
                const mult = 1 + (enemyFloor * 0.2); // Tăng 20% mỗi tầng
                return {
                    hp: Math.floor(1000 * mult), maxHp: Math.floor(1000 * mult),
                    attack: Math.floor(50 * mult),
                    defense: Math.floor(10 * mult),
                    speed: Math.floor(10 + enemyFloor),
                    crit_rate: Math.min(50, enemyFloor * 0.5),
                    name: `Yêu Thú Tầng ${enemyFloor}`
                };
            }

            const p = gameData.player;
            let s = { attack: 100, hp: 1000, defense: 20, speed: 100, crit_rate: 0, crit_dmg: 150, vamp: 0, dmg_reduce: 0 };
            
            // 1. Attributes
            s.hp += (p.attributes.body||0) * 120;
            s.attack += (p.attributes.strength||0) * 12;
            s.defense += (p.attributes.bone||0) * 16;
            s.speed += (p.attributes.agility||0) * 6;

            // 2. Equipments
            Object.values(p.equipped).forEach(it => {
                if(!it) return;
                const mul = (1 + it.enhanceLv*0.1) * (1 + it.starLv*0.2);
                Object.entries(it.baseStats).forEach(([k,v]) => s[k] = (s[k]||0) + Math.floor(v*mul));
                it.options.forEach(o => s[o.stat] = (s[o.stat]||0) + o.val);
                it.sockets.forEach(g => {
                    if(g) {
                        const baseVal = GEM_TYPES.find(gt => gt.id === g.type).val;
                        // Gem scaling: Base * Level
                        const finalVal = baseVal * g.level;
                        const statName = GEM_TYPES.find(gt => gt.id === g.type).stat;
                        s[statName] = (s[statName]||0) + finalVal;
                    }
                });
            });

            // 3. Dao/Root Bonuses (Simplified)
            if(p.daoPath === 'kiem_tu') s.attack = Math.floor(s.attack * 1.05);
            if(p.daoPath === 'the_tu') s.hp = Math.floor(s.hp * 1.2);
            // ... add more logic if needed

            s.maxHp = s.hp;
            return s;
        }

        // --- GAME LOOP ---
        function startGameLoop() {
            if(gameLoopInt) clearInterval(gameLoopInt);
            gameLoopInt = setInterval(() => {
                const now = Date.now();
                const diff = Math.min(now - gameData.lastTick, 86400000) / 1000;
                gameData.lastTick = now;

                const p = gameData.player;
                // Idle Gains
                const stoneGain = Math.floor((Math.floor(p.level/3)+1) * diff);
                gameData.resources.spirit_stones += stoneGain;
                
                const maxExp = getMaxExp(p.level);
                let expGain = Math.floor((maxExp / 450) * diff);
                if(expGain < 1) expGain = 1;
                p.exp += expGain;

                // Auto Drop
                if(Math.random() < 0.1 * diff) {
                    const drop = generateItem(p.level);
                    addItem(drop);
                    showToast(`Nhặt được: ${drop.name}`);
                }

                // Level Up
                while(p.exp >= maxExp && p.level < 225) {
                    p.exp -= maxExp; p.level++; p.potentialPoints += 10;
                    showToast(`Lên cấp: ${p.level}`, 'gold');
                }
                
                updateUI();
                saveData();
            }, 1000);
        }

        // --- ITEM SYSTEM ---
        function generateItem(lv) {
            const rand = Math.random();
            // 20% Gem/Mat, 80% Equip
            if(rand < 0.2) {
                // Mats
                if(Math.random() < 0.5) {
                    const mats = ['stone_enhance','stone_refine','stone_star'];
                    const m = mats[Math.floor(Math.random()*mats.length)];
                    return { isEquip: false, type: 'material', id: m, name: (m==='stone_enhance'?'Đá Cường Hóa':m==='stone_refine'?'Đá Tẩy Luyện':'Đá Thăng Tinh'), count: 1, desc: 'Nguyên liệu' };
                } else {
                    // Gems (Lv1)
                    const g = GEM_TYPES[Math.floor(Math.random()*GEM_TYPES.length)];
                    return { isEquip: false, type: 'gem', gemType: g.id, level: 1, name: `${g.name} Cấp 1`, count: 1, desc: g.desc };
                }
            } else {
                // Equips
                const slots = ['than_binh','huyen_quan','linh_giap','huyen_quan_leg','than_hai','nhan_trai','nhan_phai','ngoc_boi'];
                const slot = slots[Math.floor(Math.random()*slots.length)];
                const qRand = Math.random();
                let q = 0;
                if(qRand < 0.005) q=5; else if(qRand < 0.02) q=4; else if(qRand < 0.1) q=3; else if(qRand < 0.3) q=2; else if(qRand < 0.6) q=1;
                
                const names = {'than_binh':'Kiếm','huyen_quan':'Mũ','linh_giap':'Áo','huyen_quan_leg':'Quần','than_hai':'Giày','nhan_trai':'Nhẫn','nhan_phai':'Nhẫn','ngoc_boi':'Ngọc'};
                const baseVal = lv * (q+1) * 2;
                
                let stats = {};
                if(slot.includes('binh') || slot.includes('nhan')) stats.attack = baseVal;
                else if(slot.includes('giap') || slot.includes('leg')) stats.hp = baseVal * 10;
                else stats.defense = Math.floor(baseVal / 2);

                let opts = [];
                for(let i=0; i<=q; i++) {
                    const types = ['attack','hp','defense','crit_rate','speed'];
                    const t = types[Math.floor(Math.random()*types.length)];
                    opts.push({ stat: t, val: Math.floor(baseVal * 0.2) });
                }

                return {
                    id: Date.now() + Math.random(), isEquip: true, type: slot, quality: q, level: lv,
                    name: `[${['Phàm','Khá','Tốt','Hiếm','Thuyết','Thần'][q]}] ${names[slot]}`,
                    baseStats: stats, options: opts, enhanceLv: 0, starLv: 0, sockets: [null,null,null]
                };
            }
        }

        function addItem(item) {
            if(item.isEquip) gameData.inventory.equips.push(item);
            else {
                const ex = gameData.inventory.items.find(i => 
                    i.type === item.type && i.id === item.id && (item.type !== 'gem' || i.gemType === item.gemType && i.level === item.level)
                );
                if(ex) ex.count += item.count;
                else gameData.inventory.items.push(item);
            }
        }

        // --- UI & MODALS ---
        function updateUI() {
            const p = gameData.player;
            document.getElementById('display-name').innerText = p.name;
            document.getElementById('display-stones').innerText = p.resources.spirit_stones.toLocaleString();
            document.getElementById('display-tower-pts').innerText = (gameData.tower?.points || 0).toLocaleString();
            
            const max = getMaxExp(p.level);
            document.getElementById('exp-bar').style.width = Math.min(100, (p.exp/max)*100) + '%';
            document.getElementById('exp-text').innerText = `${p.exp.toLocaleString()} / ${max.toLocaleString()}`;

            // Dots
            document.getElementById('noti-inv').className = gameData.inventory.equips.length > 0 ? "absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full" : "hidden";
        }

        function showToast(msg, type='norm') {
            const t = document.getElementById('toast-container');
            const d = document.createElement('div');
            d.className = `toast border-l-4 ${type==='gold'?'border-yellow-500':'border-blue-500'}`;
            d.innerText = msg;
            t.appendChild(d);
            setTimeout(() => d.remove(), 3000);
        }

        function openModal(type) {
            document.getElementById('modal-overlay').classList.remove('hidden');
            const content = document.getElementById('modal-content');
            content.innerHTML = '';
            
            if(type === 'character') renderCharacter(content);
            else if(type === 'inventory') renderInventory(content);
            else if(type === 'blacksmith') renderBlacksmith(content);
            else if(type === 'tower') renderTower(content);
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        // --- INVENTORY LOGIC (BULK SELL) ---
        function renderInventory(c) {
            c.innerHTML = `
                <div class="p-3 bg-gray-800 flex justify-between items-center border-b border-gray-700">
                    <h3 class="font-bold text-blue-400">TÚI ĐỒ</h3>
                    <button onclick="closeModal()"><i class="fa-solid fa-times text-gray-400"></i></button>
                </div>
                <div class="flex border-b border-gray-700">
                    <button onclick="renderInvList(true)" class="flex-1 py-2 text-sm font-bold bg-gray-700 text-white">Trang Bị</button>
                    <button onclick="renderInvList(false)" class="flex-1 py-2 text-sm font-bold bg-gray-800 text-gray-400">Vật Phẩm</button>
                </div>
                
                <div class="p-2 bg-gray-800 flex gap-2 overflow-x-auto text-[10px]">
                    <span class="text-gray-400 py-1">Bán Nhanh:</span>
                    <button onclick="bulkSell(0)" class="px-2 py-1 bg-gray-600 rounded">Phàm</button>
                    <button onclick="bulkSell(1)" class="px-2 py-1 bg-green-900 rounded text-green-200">Khá</button>
                    <button onclick="bulkSell(2)" class="px-2 py-1 bg-blue-900 rounded text-blue-200">Tốt</button>
                    <button onclick="bulkSell(3)" class="px-2 py-1 bg-purple-900 rounded text-purple-200">Hiếm</button>
                </div>

                <div id="inv-list" class="flex-1 overflow-y-auto p-2 grid grid-cols-5 gap-2 content-start custom-scroll"></div>
                <div id="inv-detail" class="h-32 bg-gray-800 border-t border-gray-700 p-2 text-xs"></div>
            `;
            renderInvList(true);
        }

        function renderInvList(isEquip) {
            const list = document.getElementById('inv-list');
            list.innerHTML = '';
            
            const arr = isEquip ? gameData.inventory.equips : gameData.inventory.items;
            arr.forEach((it, idx) => {
                const color = isEquip ? `q-${it.quality}` : 'text-white';
                list.innerHTML += `
                <div onclick="selectInvItem(${idx}, ${isEquip})" class="aspect-square bg-gray-900 border border-gray-700 rounded hover:border-yellow-500 cursor-pointer flex flex-col items-center justify-center relative p-1">
                    <i class="fa-solid ${isEquip ? 'fa-shield-halved' : (it.type==='gem'?'fa-gem':'fa-cubes')} text-xl ${color}"></i>
                    <div class="text-[9px] truncate w-full text-center mt-1 ${color}">${it.name}</div>
                    ${!isEquip ? `<div class="absolute bottom-0 right-1 text-[9px]">x${it.count}</div>` : ''}
                </div>`;
            });
        }

        function selectInvItem(idx, isEquip) {
            const it = isEquip ? gameData.inventory.equips[idx] : gameData.inventory.items[idx];
            selectedItem = { item: it, idx: idx, isEquip: isEquip };
            const d = document.getElementById('inv-detail');
            
            if(isEquip) {
                let stats = Object.entries(it.baseStats).map(([k,v]) => `${k}: +${v}`).join(', ');
                d.innerHTML = `
                    <div class="flex gap-2 h-full">
                        <div class="w-20 bg-gray-900 border border-gray-600 flex items-center justify-center"><i class="fa-solid fa-shield-halved text-4xl q-${it.quality}"></i></div>
                        <div class="flex-1 overflow-y-auto">
                            <div class="font-bold q-${it.quality}">${it.name} (+${it.enhanceLv})</div>
                            <div class="text-gray-400">${stats}</div>
                        </div>
                        <div class="flex flex-col gap-1 justify-center">
                            <button onclick="doEquip(${idx})" class="bg-green-700 text-white px-3 py-1 rounded">Mặc</button>
                            <button onclick="doSellOne(${idx}, true)" class="bg-red-800 text-white px-3 py-1 rounded">Bán</button>
                        </div>
                    </div>`;
            } else {
                d.innerHTML = `
                    <div class="flex gap-2 h-full">
                         <div class="w-20 bg-gray-900 border border-gray-600 flex items-center justify-center"><i class="fa-solid ${it.type==='gem'?'fa-gem':'fa-cubes'} text-4xl text-white"></i></div>
                         <div class="flex-1">
                            <div class="font-bold text-white">${it.name}</div>
                            <div class="italic text-gray-400">${it.desc}</div>
                             ${it.type==='gem' ? `<div class="text-yellow-500 mt-1">Chỉ số: +${GEM_TYPES.find(g=>g.id===it.gemType).val * it.level} ${GEM_TYPES.find(g=>g.id===it.gemType).desc}</div>` : ''}
                        </div>
                    </div>`;
            }
        }

        function bulkSell(q) {
            const oldLen = gameData.inventory.equips.length;
            gameData.inventory.equips = gameData.inventory.equips.filter(it => it.quality !== q);
            const sold = oldLen - gameData.inventory.equips.length;
            if(sold > 0) {
                const stones = sold * (q+1) * 100;
                gameData.resources.spirit_stones += stones;
                showToast(`Đã bán ${sold} trang bị, nhận ${stones} linh thạch`);
                renderInvList(true);
            } else showToast("Không có trang bị phù hợp");
        }
        
        function doEquip(idx) {
            const item = gameData.inventory.equips[idx];
            const slot = item.type;
            const old = gameData.player.equipped[slot];
            gameData.player.equipped[slot] = item;
            gameData.inventory.equips.splice(idx, 1);
            if(old) gameData.inventory.equips.push(old);
            showToast("Đã trang bị!");
            renderInvList(true);
        }
        
        function doSellOne(idx) {
            const item = gameData.inventory.equips[idx];
            gameData.resources.spirit_stones += (item.quality+1)*100;
            gameData.inventory.equips.splice(idx, 1);
            renderInvList(true);
            document.getElementById('inv-detail').innerHTML = '';
        }

        // --- BLACKSMITH (FUSION & GEM) ---
        function renderBlacksmith(c) {
            c.innerHTML = `
                <div class="p-3 bg-gray-800 flex justify-between items-center border-b border-gray-700">
                    <h3 class="font-bold text-orange-400">THỢ RÈN</h3>
                    <button onclick="closeModal()"><i class="fa-solid fa-times text-gray-400"></i></button>
                </div>
                <div class="flex h-full">
                    <div class="w-1/4 bg-gray-800 border-r border-gray-700 p-2 space-y-2">
                        <button onclick="renderGemFuse()" class="w-full text-left p-2 bg-gray-700 rounded text-sm hover:bg-gray-600">Ghép Ngọc</button>
                        <button onclick="renderEnhanceUI()" class="w-full text-left p-2 bg-gray-700 rounded text-sm hover:bg-gray-600">Cường Hóa</button>
                    </div>
                    <div id="bs-content" class="flex-1 p-4 bg-gray-900 flex flex-col items-center justify-center">
                        <div class="text-gray-500">Chọn chức năng bên trái</div>
                    </div>
                </div>
            `;
        }

        function renderGemFuse() {
            const gems = gameData.inventory.items.filter(i => i.type === 'gem');
            let html = '<h4 class="text-yellow-500 font-bold mb-4">GHÉP NGỌC (3 viên -> 1 viên cấp cao)</h4><div class="grid grid-cols-4 gap-2 w-full">';
            
            gems.sort((a,b) => (a.gemType+a.level).localeCompare(b.gemType+b.level));
            
            gems.forEach(g => {
                const canFuse = g.count >= 3 && g.level < 10;
                const baseInfo = GEM_TYPES.find(x => x.id === g.gemType);
                const statVal = baseInfo.val * g.level;
                
                html += `
                <div class="bg-gray-800 p-2 rounded border border-gray-600 flex flex-col items-center relative">
                    <i class="fa-solid fa-gem text-2xl mb-1 ${baseInfo.id.includes('atk')?'text-red-400':baseInfo.id.includes('hp')?'text-yellow-400':'text-blue-400'}"></i>
                    <div class="text-xs font-bold text-center">${g.name}</div>
                    <div class="text-[9px] text-gray-400">+${statVal} ${baseInfo.desc}</div>
                    <div class="text-xs mt-1">SL: ${g.count}</div>
                    ${canFuse ? `<button onclick="doFuse('${g.id}', ${g.level}, '${g.gemType}')" class="mt-2 bg-green-700 text-white text-[10px] px-2 py-1 rounded w-full">Ghép</button>` : ''}
                </div>`;
            });
            document.getElementById('bs-content').innerHTML = html + '</div>';
        }

        function doFuse(itemId, lv, type) {
            const it = gameData.inventory.items.find(i => i.type === 'gem' && i.gemType === type && i.level === lv);
            if(it && it.count >= 3) {
                it.count -= 3;
                if(it.count === 0) gameData.inventory.items = gameData.inventory.items.filter(i => i !== it);
                
                // Add next level
                const nextLv = lv + 1;
                const baseName = GEM_TYPES.find(x => x.id === type).name;
                addItem({ isEquip: false, type: 'gem', gemType: type, level: nextLv, name: `${baseName} Cấp ${nextLv}`, count: 1 });
                
                showToast("Ghép ngọc thành công!", 'gold');
                renderGemFuse();
            }
        }
        
        function renderEnhanceUI() {
             document.getElementById('bs-content').innerHTML = '<div class="text-gray-400">Chọn trang bị trong túi để cường hóa (Chưa implement UI này, dùng tính năng mặc định trong túi đồ)</div>';
        }

        // --- INFINITE TOWER ---
        function renderTower(c) {
            c.innerHTML = `
                <div class="p-3 bg-gray-800 flex justify-between items-center border-b border-gray-700">
                    <h3 class="font-bold text-purple-400">THÁP VÔ TẬN</h3>
                    <button onclick="closeModal()"><i class="fa-solid fa-times text-gray-400"></i></button>
                </div>
                <div class="flex-1 flex flex-col p-4">
                    <div class="text-center mb-6">
                        <div class="text-4xl font-bold text-white mb-2">Tầng ${gameData.tower.floor}</div>
                        <div class="text-gray-400">Quái vật mạnh lên theo từng tầng. Đánh thắng nhận Điểm Tháp & Linh Thạch.</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <button onclick="startTowerCombat()" class="bg-red-900 hover:bg-red-800 text-white font-bold py-4 rounded border border-red-600 text-xl">
                            KHIÊU CHIẾN
                        </button>
                        <button onclick="renderTowerShop()" class="bg-purple-900 hover:bg-purple-800 text-white font-bold py-4 rounded border border-purple-600 text-xl">
                            TIỆM THÁP
                        </button>
                    </div>

                    <div id="combat-log" class="flex-1 bg-black border border-gray-700 rounded p-2 overflow-y-auto font-mono text-xs combat-log hidden">
                        </div>
                </div>
            `;
        }
        
        function renderTowerShop() {
            const c = document.getElementById('modal-content');
            c.innerHTML = `
                 <div class="p-3 bg-gray-800 flex justify-between items-center border-b border-gray-700">
                    <h3 class="font-bold text-purple-400">TIỆM THÁP (Điểm: ${gameData.tower.points})</h3>
                    <button onclick="openModal('tower')"><i class="fa-solid fa-arrow-left text-gray-400"></i></button>
                </div>
                <div class="p-4 grid grid-cols-3 gap-2">
                    ${GEM_TYPES.map(g => `
                        <div class="bg-gray-800 p-2 border border-gray-600 rounded flex flex-col items-center">
                            <i class="fa-solid fa-gem text-xl mb-1 text-white"></i>
                            <div class="font-bold text-sm text-white">${g.name} Cấp 1</div>
                            <div class="text-xs text-gray-400">+${g.val} ${g.desc}</div>
                            <button onclick="buyGem('${g.id}')" class="mt-2 bg-yellow-700 px-3 py-1 rounded text-xs text-white">Mua (100 Điểm)</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function buyGem(type) {
            if(gameData.tower.points >= 100) {
                gameData.tower.points -= 100;
                const g = GEM_TYPES.find(x => x.id === type);
                addItem({ isEquip: false, type: 'gem', gemType: type, level: 1, name: `${g.name} Cấp 1`, count: 1, desc: g.desc });
                showToast("Mua thành công!");
                renderTowerShop();
                saveData();
            } else showToast("Không đủ điểm!");
        }

        async function startTowerCombat() {
            const logBox = document.getElementById('combat-log');
            logBox.classList.remove('hidden');
            logBox.innerHTML = '<p class="text-center text-white">--- TRẬN CHIẾN BẮT ĐẦU ---</p>';
            
            let pStats = calculateStats('player');
            let eStats = calculateStats('enemy', gameData.tower.floor);
            
            let turn = 1;
            while(pStats.hp > 0 && eStats.hp > 0) {
                // Sleep for effect
                await new Promise(r => setTimeout(r, 600)); 
                
                // Player Attack
                const pDmg = Math.max(1, pStats.attack - eStats.defense);
                eStats.hp -= pDmg;
                logBox.innerHTML += `<p class="log-player">Turn ${turn}: Bạn đánh ${eStats.name} mất ${pDmg} máu. (Địch còn ${eStats.hp})</p>`;
                logBox.scrollTop = logBox.scrollHeight;

                if(eStats.hp <= 0) break;

                // Enemy Attack
                const eDmg = Math.max(1, eStats.attack - pStats.defense);
                pStats.hp -= eDmg;
                logBox.innerHTML += `<p class="log-enemy">Turn ${turn}: ${eStats.name} đánh bạn mất ${eDmg} máu. (Bạn còn ${pStats.hp})</p>`;
                logBox.scrollTop = logBox.scrollHeight;
                
                turn++;
            }

            if(pStats.hp > 0) {
                const pts = 10 + Math.floor(gameData.tower.floor/10);
                const stones = 50 + gameData.tower.floor * 5;
                gameData.tower.floor++;
                gameData.tower.points += pts;
                gameData.resources.spirit_stones += stones;
                logBox.innerHTML += `<p class="log-info text-center mt-2">CHIẾN THẮNG! Nhận ${pts} điểm, ${stones} linh thạch.</p>`;
                saveData();
            } else {
                logBox.innerHTML += `<p class="text-red-500 font-bold text-center mt-2">THẤT BẠI!</p>`;
            }
        }

        // --- INIT & FIX SELECTION ---
        window.onload = function() {
            if(localStorage.getItem(LOCAL_STORAGE_KEY)) {
                document.getElementById('btn-continue').classList.remove('hidden');
            } else {
                // Pre-render modal content if new game
            }
        };

        function newGame() {
            if(localStorage.getItem(LOCAL_STORAGE_KEY) && !confirm("Xóa dữ liệu cũ?")) return;
            initData();
            document.getElementById('modal-selection').classList.remove('hidden');
            renderSelectionUI();
        }
        
        function initData() {
            gameData = {
                player: { name: 'Vô Danh', level: 1, exp: 0, potentialPoints: 0, equipped: {}, attributes: {}, daoPath: null },
                resources: { spirit_stones: 0 },
                inventory: { equips: [], items: [] },
                tower: { floor: 1, points: 0 },
                lastTick: Date.now()
            };
        }

        function renderSelectionUI() {
            const daoDiv = document.getElementById('dao-list');
            const rootDiv = document.getElementById('root-list');
            
            daoDiv.innerHTML = Object.entries(DAO_PATHS).map(([k, v]) => `
                <div onclick="selectDao('${k}')" id="dao-btn-${k}" class="p-2 border border-gray-600 rounded hover:bg-gray-800 cursor-pointer">
                    <div class="font-bold text-yellow-500 text-sm">${v.name}</div>
                    <div class="text-[10px] text-gray-400">${v.desc}</div>
                </div>`).join('');
            
            rootDiv.innerHTML = Object.entries(SPIRIT_ROOTS).map(([k, v]) => `
                <div onclick="selectRoot('${k}')" id="root-btn-${k}" class="p-2 border border-gray-600 rounded hover:bg-gray-800 cursor-pointer">
                    <div class="font-bold ${v.color} text-sm">${v.name} Linh Căn</div>
                </div>`).join('');
        }

        function selectDao(k) {
            tempSel.dao = k;
            document.querySelectorAll('#dao-list > div').forEach(d => d.classList.remove('border-yellow-500', 'bg-gray-800'));
            document.getElementById(`dao-btn-${k}`).classList.add('border-yellow-500', 'bg-gray-800');
            document.getElementById('sel-dao-txt').innerText = DAO_PATHS[k].name;
            checkConfirm();
        }

        function selectRoot(k) {
            tempSel.root = k;
            document.querySelectorAll('#root-list > div').forEach(d => d.classList.remove('border-yellow-500', 'bg-gray-800'));
            document.getElementById(`root-btn-${k}`).classList.add('border-yellow-500', 'bg-gray-800');
            document.getElementById('sel-root-txt').innerText = SPIRIT_ROOTS[k].name;
            checkConfirm();
        }

        function checkConfirm() {
            const btn = document.getElementById('btn-sel-confirm');
            if(tempSel.dao && tempSel.root) {
                btn.disabled = false;
                btn.className = "px-6 py-2 bg-yellow-600 text-white font-bold rounded hover:bg-yellow-500";
            }
        }

        function confirmSelection() {
            gameData.player.daoPath = tempSel.dao;
            gameData.player.spiritRoot = tempSel.root;
            saveData();
            document.getElementById('modal-selection').classList.add('hidden');
            enterGame();
        }

        function continueGame() {
            try {
                const saved = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY));
                gameData = saved;
                // Patch old data
                if(!gameData.tower) gameData.tower = { floor: 1, points: 0 };
                enterGame();
            } catch(e) { initData(); newGame(); }
        }

        function enterGame() {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            updateUI();
            startGameLoop();
        }
        
        function returnToMenu() {
            clearInterval(gameLoopInt);
            saveData();
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
        }

        function saveData() { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(gameData)); }
        function triggerFileInput() { document.getElementById('file-upload').click(); }
        function handleFileUpload(input) { const f = input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ gameData=JSON.parse(e.target.result); saveData(); enterGame(); }; r.readAsText(f); }
        function exportSaveFile() { const b = new Blob([JSON.stringify(gameData)], {type:"application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'save.json'; a.click(); }
        
        // Placeholder for other modals to avoid error
        function renderCharacter(c) { c.innerHTML = '<div class="p-4 text-white">Character UI (Use basic stats)</div>'; }

    </script>
</body>
</html>